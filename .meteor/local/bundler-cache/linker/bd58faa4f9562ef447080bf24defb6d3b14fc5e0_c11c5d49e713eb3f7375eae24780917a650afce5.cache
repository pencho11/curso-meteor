[{"type":"js","data":"//////////////////////////////////////////////////////////////////////////\n//                                                                      //\n// This is a generated file. You can view the original                  //\n// source in your browser if your browser supports source maps.         //\n// Source maps are supported by all recent versions of Chrome, Safari,  //\n// and Firefox, and by Internet Explorer 11.                            //\n//                                                                      //\n//////////////////////////////////////////////////////////////////////////\n\n\n(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar global = Package.meteor.global;\nvar meteorEnv = Package.meteor.meteorEnv;\nvar Mongo = Package.mongo.Mongo;\nvar Tracker = Package.tracker.Tracker;\nvar Deps = Package.tracker.Deps;\nvar EJSON = Package.ejson.EJSON;\nvar LocalCollection = Package.minimongo.LocalCollection;\nvar Minimongo = Package.minimongo.Minimongo;\nvar meteorInstall = Package.modules.meteorInstall;\nvar meteorBabelHelpers = Package.modules.meteorBabelHelpers;\nvar Promise = Package.promise.Promise;\nvar Symbol = Package['ecmascript-runtime-client'].Symbol;\nvar Map = Package['ecmascript-runtime-client'].Map;\nvar Set = Package['ecmascript-runtime-client'].Set;\n\n/* Package-scope variables */\nvar CollectionHooks;\n\nvar require = meteorInstall({\"node_modules\":{\"meteor\":{\"matb33:collection-hooks\":{\"client.js\":function module(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/matb33_collection-hooks/client.js                                                                          //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\nmodule.export({\n  CollectionHooks: function () {\n    return CollectionHooks;\n  }\n});\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 1);\nvar CollectionHooks;\nmodule.link(\"./collection-hooks.js\", {\n  CollectionHooks: function (v) {\n    CollectionHooks = v;\n  }\n}, 2);\nmodule.link(\"./advices\");\n\nCollectionHooks.getUserId = function () {\n  function getUserId() {\n    var userId;\n    Tracker.nonreactive(function () {\n      userId = Meteor.userId && Meteor.userId();\n    });\n\n    if (userId == null) {\n      userId = CollectionHooks.defaultUserId;\n    }\n\n    return userId;\n  }\n\n  return getUserId;\n}();\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n},\"advices.js\":function module(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/matb33_collection-hooks/advices.js                                                                         //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\nmodule.link(\"./insert.js\");\nmodule.link(\"./update.js\");\nmodule.link(\"./remove.js\");\nmodule.link(\"./upsert.js\");\nmodule.link(\"./find.js\");\nmodule.link(\"./findone.js\");\nmodule.link(\"./users-compat.js\");\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n},\"collection-hooks.js\":function module(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/matb33_collection-hooks/collection-hooks.js                                                                //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\nvar _objectWithoutProperties;\n\nmodule.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n  default: function (v) {\n    _objectWithoutProperties = v;\n  }\n}, 0);\n\nvar _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 1);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 2);\nmodule.export({\n  CollectionHooks: function () {\n    return CollectionHooks;\n  }\n});\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar Mongo;\nmodule.link(\"meteor/mongo\", {\n  Mongo: function (v) {\n    Mongo = v;\n  }\n}, 1);\nvar EJSON;\nmodule.link(\"meteor/ejson\", {\n  EJSON: function (v) {\n    EJSON = v;\n  }\n}, 2);\nvar LocalCollection;\nmodule.link(\"meteor/minimongo\", {\n  LocalCollection: function (v) {\n    LocalCollection = v;\n  }\n}, 3);\n// Relevant AOP terminology:\n// Aspect: User code that runs before/after (hook)\n// Advice: Wrapper code that knows when to call user code (aspects)\n// Pointcut: before/after\nvar advices = {};\nvar CollectionHooks = {\n  defaults: {\n    before: {\n      insert: {},\n      update: {},\n      remove: {},\n      upsert: {},\n      find: {},\n      findOne: {},\n      all: {}\n    },\n    after: {\n      insert: {},\n      update: {},\n      remove: {},\n      find: {},\n      findOne: {},\n      all: {}\n    },\n    all: {\n      insert: {},\n      update: {},\n      remove: {},\n      find: {},\n      findOne: {},\n      all: {}\n    }\n  },\n  directEnv: new Meteor.EnvironmentVariable(),\n  directOp: function (func) {\n    return this.directEnv.withValue(true, func);\n  },\n  hookedOp: function (func) {\n    return this.directEnv.withValue(false, func);\n  }\n};\n\nCollectionHooks.extendCollectionInstance = function () {\n  function extendCollectionInstance(self, constructor) {\n    // Offer a public API to allow the user to define aspects\n    // Example: collection.before.insert(func);\n    ['before', 'after'].forEach(function (pointcut) {\n      Object.entries(advices).forEach(function (_ref) {\n        var _ref2 = _slicedToArray(_ref, 2),\n            method = _ref2[0],\n            advice = _ref2[1];\n\n        if (advice === 'upsert' && pointcut === 'after') return;\n\n        Meteor._ensure(self, pointcut, method);\n\n        Meteor._ensure(self, '_hookAspects', method);\n\n        self._hookAspects[method][pointcut] = [];\n\n        self[pointcut][method] = function (aspect, options) {\n          var len = self._hookAspects[method][pointcut].push({\n            aspect: aspect,\n            options: CollectionHooks.initOptions(options, pointcut, method)\n          });\n\n          return {\n            replace: function (aspect, options) {\n              self._hookAspects[method][pointcut].splice(len - 1, 1, {\n                aspect: aspect,\n                options: CollectionHooks.initOptions(options, pointcut, method)\n              });\n            },\n            remove: function () {\n              self._hookAspects[method][pointcut].splice(len - 1, 1);\n            }\n          };\n        };\n      });\n    }); // Offer a publicly accessible object to allow the user to define\n    // collection-wide hook options.\n    // Example: collection.hookOptions.after.update = {fetchPrevious: false};\n\n    self.hookOptions = EJSON.clone(CollectionHooks.defaults); // Wrap mutator methods, letting the defined advice do the work\n\n    Object.entries(advices).forEach(function (_ref3) {\n      var _ref4 = _slicedToArray(_ref3, 2),\n          method = _ref4[0],\n          advice = _ref4[1];\n\n      var collection = Meteor.isClient || method === 'upsert' ? self : self._collection; // Store a reference to the original mutator method\n\n      var _super = collection[method];\n\n      Meteor._ensure(self, 'direct', method);\n\n      self.direct[method] = function () {\n        for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n          args[_key] = arguments[_key];\n        }\n\n        return CollectionHooks.directOp(function () {\n          return constructor.prototype[method].apply(self, args);\n        });\n      };\n\n      collection[method] = function () {\n        for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n          args[_key2] = arguments[_key2];\n        }\n\n        if (CollectionHooks.directEnv.get() === true) {\n          return _super.apply(collection, args);\n        } // NOTE: should we decide to force `update` with `{upsert:true}` to use\n        // the `upsert` hooks, this is what will accomplish it. It's important to\n        // realize that Meteor won't distinguish between an `update` and an\n        // `insert` though, so we'll end up with `after.update` getting called\n        // even on an `insert`. That's why we've chosen to disable this for now.\n        // if (method === \"update\" && Object(args[2]) === args[2] && args[2].upsert) {\n        //   method = \"upsert\";\n        //   advice = CollectionHooks.getAdvice(method);\n        // }\n\n\n        return advice.call(this, CollectionHooks.getUserId(), _super, self, method === 'upsert' ? {\n          insert: self._hookAspects.insert || {},\n          update: self._hookAspects.update || {},\n          upsert: self._hookAspects.upsert || {}\n        } : self._hookAspects[method] || {}, function (doc) {\n          return typeof self._transform === 'function' ? function (d) {\n            return self._transform(d || doc);\n          } : function (d) {\n            return d || doc;\n          };\n        }, args, false);\n      };\n    });\n  }\n\n  return extendCollectionInstance;\n}();\n\nCollectionHooks.defineAdvice = function (method, advice) {\n  advices[method] = advice;\n};\n\nCollectionHooks.getAdvice = function (method) {\n  return advices[method];\n};\n\nCollectionHooks.initOptions = function (options, pointcut, method) {\n  return CollectionHooks.extendOptions(CollectionHooks.defaults, options, pointcut, method);\n};\n\nCollectionHooks.extendOptions = function (source, options, pointcut, method) {\n  return _objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({}, options), source.all.all), source[pointcut].all), source.all[method]), source[pointcut][method]);\n};\n\nCollectionHooks.getDocs = function () {\n  function getDocs(collection, selector, options) {\n    var findOptions = {\n      transform: null,\n      reactive: false\n    }; // added reactive: false\n\n    /*\n    // No \"fetch\" support at this time.\n    if (!this._validators.fetchAllFields) {\n      findOptions.fields = {};\n      this._validators.fetch.forEach(function(fieldName) {\n        findOptions.fields[fieldName] = 1;\n      });\n    }\n    */\n    // Bit of a magic condition here... only \"update\" passes options, so this is\n    // only relevant to when update calls getDocs:\n\n    if (options) {\n      // This was added because in our case, we are potentially iterating over\n      // multiple docs. If multi isn't enabled, force a limit (almost like\n      // findOne), as the default for update without multi enabled is to affect\n      // only the first matched document:\n      if (!options.multi) {\n        findOptions.limit = 1;\n      }\n\n      var multi = options.multi,\n          upsert = options.upsert,\n          rest = _objectWithoutProperties(options, [\"multi\", \"upsert\"]);\n\n      Object.assign(findOptions, rest);\n    } // Unlike validators, we iterate over multiple docs, so use\n    // find instead of findOne:\n\n\n    return collection.find(selector, findOptions);\n  }\n\n  return getDocs;\n}(); // This function normalizes the selector (converting it to an Object)\n\n\nCollectionHooks.normalizeSelector = function (selector) {\n  if (typeof selector === 'string' || selector && selector.constructor === Mongo.ObjectID) {\n    return {\n      _id: selector\n    };\n  } else {\n    return selector;\n  }\n}; // This function contains a snippet of code pulled and modified from:\n// ~/.meteor/packages/mongo-livedata/collection.js\n// It's contained in these utility functions to make updates easier for us in\n// case this code changes.\n\n\nCollectionHooks.getFields = function () {\n  function getFields(mutator) {\n    // compute modified fields\n    var fields = []; // ====ADDED START=======================\n\n    var operators = ['$addToSet', '$bit', '$currentDate', '$inc', '$max', '$min', '$pop', '$pull', '$pullAll', '$push', '$rename', '$set', '$unset']; // ====ADDED END=========================\n\n    Object.entries(mutator).forEach(function (_ref5) {\n      var _ref6 = _slicedToArray(_ref5, 2),\n          op = _ref6[0],\n          params = _ref6[1];\n\n      // ====ADDED START=======================\n      if (operators.includes(op)) {\n        // ====ADDED END=========================\n        Object.keys(params).forEach(function (field) {\n          // treat dotted fields as if they are replacing their\n          // top-level part\n          if (field.indexOf('.') !== -1) {\n            field = field.substring(0, field.indexOf('.'));\n          } // record the field we are trying to change\n\n\n          if (!fields.includes(field)) {\n            fields.push(field);\n          }\n        }); // ====ADDED START=======================\n      } else {\n        fields.push(op);\n      } // ====ADDED END=========================\n\n    });\n    return fields;\n  }\n\n  return getFields;\n}();\n\nCollectionHooks.reassignPrototype = function () {\n  function reassignPrototype(instance, constr) {\n    var hasSetPrototypeOf = typeof Object.setPrototypeOf === 'function';\n    constr = constr || Mongo.Collection; // __proto__ is not available in < IE11\n    // Note: Assigning a prototype dynamically has performance implications\n\n    if (hasSetPrototypeOf) {\n      Object.setPrototypeOf(instance, constr.prototype);\n    } else if (instance.__proto__) {\n      // eslint-disable-line no-proto\n      instance.__proto__ = constr.prototype; // eslint-disable-line no-proto\n    }\n  }\n\n  return reassignPrototype;\n}();\n\nCollectionHooks.wrapCollection = function () {\n  function wrapCollection(ns, as) {\n    if (!as._CollectionConstructor) as._CollectionConstructor = as.Collection;\n    if (!as._CollectionPrototype) as._CollectionPrototype = new as.Collection(null);\n    var constructor = ns._NewCollectionContructor || as._CollectionConstructor;\n    var proto = as._CollectionPrototype;\n\n    ns.Collection = function () {\n      for (var _len3 = arguments.length, args = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {\n        args[_key3] = arguments[_key3];\n      }\n\n      var ret = constructor.apply(this, args);\n      CollectionHooks.extendCollectionInstance(this, constructor);\n      return ret;\n    }; // Retain a reference to the new constructor to allow further wrapping.\n\n\n    ns._NewCollectionContructor = ns.Collection;\n    ns.Collection.prototype = proto;\n    ns.Collection.prototype.constructor = ns.Collection;\n\n    for (var _i = 0, _Object$keys = Object.keys(constructor); _i < _Object$keys.length; _i++) {\n      var prop = _Object$keys[_i];\n      ns.Collection[prop] = constructor[prop];\n    } // Meteor overrides the apply method which is copied from the constructor in the loop above. Replace it with the\n    // default method which we need if we were to further wrap ns.Collection.\n\n\n    ns.Collection.apply = Function.prototype.apply;\n  }\n\n  return wrapCollection;\n}();\n\nCollectionHooks.modify = LocalCollection._modify;\n\nif (typeof Mongo !== 'undefined') {\n  CollectionHooks.wrapCollection(Meteor, Mongo);\n  CollectionHooks.wrapCollection(Mongo, Mongo);\n} else {\n  CollectionHooks.wrapCollection(Meteor, Meteor);\n}\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n},\"find.js\":function module(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/matb33_collection-hooks/find.js                                                                            //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\nvar CollectionHooks;\nmodule.link(\"./collection-hooks\", {\n  CollectionHooks: function (v) {\n    CollectionHooks = v;\n  }\n}, 0);\nCollectionHooks.defineAdvice('find', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  var ctx = {\n    context: this,\n    _super: _super,\n    args: args\n  };\n  var selector = CollectionHooks.normalizeSelector(instance._getFindSelector(args));\n\n  var options = instance._getFindOptions(args);\n\n  var abort; // before\n\n  if (!suppressAspects) {\n    aspects.before.forEach(function (o) {\n      var r = o.aspect.call(ctx, userId, selector, options);\n      if (r === false) abort = true;\n    });\n    if (abort) return instance.find(undefined);\n  }\n\n  var after = function (cursor) {\n    if (!suppressAspects) {\n      aspects.after.forEach(function (o) {\n        o.aspect.call(ctx, userId, selector, options, cursor);\n      });\n    }\n  };\n\n  var ret = _super.call(this, selector, options);\n\n  after(ret);\n  return ret;\n});\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n},\"findone.js\":function module(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/matb33_collection-hooks/findone.js                                                                         //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\nvar CollectionHooks;\nmodule.link(\"./collection-hooks\", {\n  CollectionHooks: function (v) {\n    CollectionHooks = v;\n  }\n}, 0);\nCollectionHooks.defineAdvice('findOne', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  var ctx = {\n    context: this,\n    _super: _super,\n    args: args\n  };\n  var selector = CollectionHooks.normalizeSelector(instance._getFindSelector(args));\n\n  var options = instance._getFindOptions(args);\n\n  var abort; // before\n\n  if (!suppressAspects) {\n    aspects.before.forEach(function (o) {\n      var r = o.aspect.call(ctx, userId, selector, options);\n      if (r === false) abort = true;\n    });\n    if (abort) return;\n  }\n\n  function after(doc) {\n    if (!suppressAspects) {\n      aspects.after.forEach(function (o) {\n        o.aspect.call(ctx, userId, selector, options, doc);\n      });\n    }\n  }\n\n  var ret = _super.call(this, selector, options);\n\n  after(ret);\n  return ret;\n});\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n},\"insert.js\":function module(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/matb33_collection-hooks/insert.js                                                                          //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\nvar _typeof;\n\nmodule.link(\"@babel/runtime/helpers/typeof\", {\n  default: function (v) {\n    _typeof = v;\n  }\n}, 0);\n\nvar _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 1);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 2);\nvar EJSON;\nmodule.link(\"meteor/ejson\", {\n  EJSON: function (v) {\n    EJSON = v;\n  }\n}, 0);\nvar Mongo;\nmodule.link(\"meteor/mongo\", {\n  Mongo: function (v) {\n    Mongo = v;\n  }\n}, 1);\nvar CollectionHooks;\nmodule.link(\"./collection-hooks\", {\n  CollectionHooks: function (v) {\n    CollectionHooks = v;\n  }\n}, 2);\nCollectionHooks.defineAdvice('insert', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  var ctx = {\n    context: this,\n    _super: _super,\n    args: args\n  };\n\n  var _args = _slicedToArray(args, 2),\n      doc = _args[0],\n      callback = _args[1];\n\n  var async = typeof callback === 'function';\n  var abort;\n  var ret; // before\n\n  if (!suppressAspects) {\n    try {\n      aspects.before.forEach(function (o) {\n        var r = o.aspect.call(_objectSpread({\n          transform: getTransform(doc)\n        }, ctx), userId, doc);\n        if (r === false) abort = true;\n      });\n      if (abort) return;\n    } catch (e) {\n      if (async) return callback.call(this, e);\n      throw e;\n    }\n  }\n\n  var after = function (id, err) {\n    if (id) {\n      // In some cases (namely Meteor.users on Meteor 1.4+), the _id property\n      // is a raw mongo _id object. We need to extract the _id from this object\n      if (_typeof(id) === 'object' && id.ops) {\n        // If _str then collection is using Mongo.ObjectID as ids\n        if (doc._id._str) {\n          id = new Mongo.ObjectID(doc._id._str.toString());\n        } else {\n          id = id.ops && id.ops[0] && id.ops[0]._id;\n        }\n      }\n\n      doc = EJSON.clone(doc);\n      doc._id = id;\n    }\n\n    if (!suppressAspects) {\n      var lctx = _objectSpread({\n        transform: getTransform(doc),\n        _id: id,\n        err: err\n      }, ctx);\n\n      aspects.after.forEach(function (o) {\n        o.aspect.call(lctx, userId, doc);\n      });\n    }\n\n    return id;\n  };\n\n  if (async) {\n    var wrappedCallback = function (err, obj) {\n      after(obj && obj[0] && obj[0]._id || obj, err);\n\n      for (var _len = arguments.length, args = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n        args[_key - 2] = arguments[_key];\n      }\n\n      return callback.call.apply(callback, [this, err, obj].concat(args));\n    };\n\n    return _super.call(this, doc, wrappedCallback);\n  } else {\n    ret = _super.call(this, doc, callback);\n    return after(ret && ret[0] && ret[0]._id || ret);\n  }\n});\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n},\"remove.js\":function module(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/matb33_collection-hooks/remove.js                                                                          //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\nvar _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 0);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\nvar EJSON;\nmodule.link(\"meteor/ejson\", {\n  EJSON: function (v) {\n    EJSON = v;\n  }\n}, 0);\nvar CollectionHooks;\nmodule.link(\"./collection-hooks\", {\n  CollectionHooks: function (v) {\n    CollectionHooks = v;\n  }\n}, 1);\n\nvar isEmpty = function (a) {\n  return !Array.isArray(a) || !a.length;\n};\n\nCollectionHooks.defineAdvice('remove', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  var ctx = {\n    context: this,\n    _super: _super,\n    args: args\n  };\n\n  var _args = _slicedToArray(args, 2),\n      selector = _args[0],\n      callback = _args[1];\n\n  var async = typeof callback === 'function';\n  var docs;\n  var abort;\n  var prev = [];\n\n  if (!suppressAspects) {\n    try {\n      if (!isEmpty(aspects.before) || !isEmpty(aspects.after)) {\n        docs = CollectionHooks.getDocs.call(this, instance, selector).fetch();\n      } // copy originals for convenience for the 'after' pointcut\n\n\n      if (!isEmpty(aspects.after)) {\n        docs.forEach(function (doc) {\n          return prev.push(EJSON.clone(doc));\n        });\n      } // before\n\n\n      aspects.before.forEach(function (o) {\n        docs.forEach(function (doc) {\n          var r = o.aspect.call(_objectSpread({\n            transform: getTransform(doc)\n          }, ctx), userId, doc);\n          if (r === false) abort = true;\n        });\n      });\n      if (abort) return 0;\n    } catch (e) {\n      if (async) return callback.call(this, e);\n      throw e;\n    }\n  }\n\n  function after(err) {\n    if (!suppressAspects) {\n      aspects.after.forEach(function (o) {\n        prev.forEach(function (doc) {\n          o.aspect.call(_objectSpread({\n            transform: getTransform(doc),\n            err: err\n          }, ctx), userId, doc);\n        });\n      });\n    }\n  }\n\n  if (async) {\n    var wrappedCallback = function (err) {\n      after(err);\n\n      for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n        args[_key - 1] = arguments[_key];\n      }\n\n      return callback.call.apply(callback, [this, err].concat(args));\n    };\n\n    return _super.call(this, selector, wrappedCallback);\n  } else {\n    var result = _super.call(this, selector, callback);\n\n    after();\n    return result;\n  }\n});\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n},\"update.js\":function module(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/matb33_collection-hooks/update.js                                                                          //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\nvar _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 0);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\nvar EJSON;\nmodule.link(\"meteor/ejson\", {\n  EJSON: function (v) {\n    EJSON = v;\n  }\n}, 0);\nvar CollectionHooks;\nmodule.link(\"./collection-hooks\", {\n  CollectionHooks: function (v) {\n    CollectionHooks = v;\n  }\n}, 1);\n\nvar isEmpty = function (a) {\n  return !Array.isArray(a) || !a.length;\n};\n\nCollectionHooks.defineAdvice('update', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  var _this = this;\n\n  var ctx = {\n    context: this,\n    _super: _super,\n    args: args\n  };\n\n  var _args = _slicedToArray(args, 4),\n      selector = _args[0],\n      mutator = _args[1],\n      options = _args[2],\n      callback = _args[3];\n\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  var async = typeof callback === 'function';\n  var docs;\n  var docIds;\n  var fields;\n  var abort;\n  var prev = {};\n\n  if (!suppressAspects) {\n    try {\n      if (!isEmpty(aspects.before) || !isEmpty(aspects.after)) {\n        fields = CollectionHooks.getFields(mutator);\n        docs = CollectionHooks.getDocs.call(this, instance, selector, options).fetch();\n        docIds = docs.map(function (doc) {\n          return doc._id;\n        });\n      } // copy originals for convenience for the 'after' pointcut\n\n\n      if (!isEmpty(aspects.after)) {\n        prev.mutator = EJSON.clone(mutator);\n        prev.options = EJSON.clone(options);\n\n        if (aspects.after.some(function (o) {\n          return o.options.fetchPrevious !== false;\n        }) && CollectionHooks.extendOptions(instance.hookOptions, {}, 'after', 'update').fetchPrevious !== false) {\n          prev.docs = {};\n          docs.forEach(function (doc) {\n            prev.docs[doc._id] = EJSON.clone(doc);\n          });\n        }\n      } // before\n\n\n      aspects.before.forEach(function (o) {\n        docs.forEach(function (doc) {\n          var r = o.aspect.call(_objectSpread({\n            transform: getTransform(doc)\n          }, ctx), userId, doc, fields, mutator, options);\n          if (r === false) abort = true;\n        });\n      });\n      if (abort) return 0;\n    } catch (e) {\n      if (async) return callback.call(this, e);\n      throw e;\n    }\n  }\n\n  var after = function (affected, err) {\n    if (!suppressAspects && !isEmpty(aspects.after)) {\n      var _fields = CollectionHooks.getFields(mutator);\n\n      var _docs = CollectionHooks.getDocs.call(_this, instance, {\n        _id: {\n          $in: docIds\n        }\n      }, options).fetch();\n\n      aspects.after.forEach(function (o) {\n        _docs.forEach(function (doc) {\n          o.aspect.call(_objectSpread({\n            transform: getTransform(doc),\n            previous: prev.docs && prev.docs[doc._id],\n            affected: affected,\n            err: err\n          }, ctx), userId, doc, _fields, prev.mutator, prev.options);\n        });\n      });\n    }\n  };\n\n  if (async) {\n    var wrappedCallback = function (err, affected) {\n      var _callback;\n\n      after(affected, err);\n\n      for (var _len = arguments.length, args = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n        args[_key - 2] = arguments[_key];\n      }\n\n      return (_callback = callback).call.apply(_callback, [this, err, affected].concat(args));\n    };\n\n    return _super.call(this, selector, mutator, options, wrappedCallback);\n  } else {\n    var affected = _super.call(this, selector, mutator, options, callback);\n\n    after(affected);\n    return affected;\n  }\n});\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n},\"upsert.js\":function module(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/matb33_collection-hooks/upsert.js                                                                          //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\nvar _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 0);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\nvar EJSON;\nmodule.link(\"meteor/ejson\", {\n  EJSON: function (v) {\n    EJSON = v;\n  }\n}, 0);\nvar CollectionHooks;\nmodule.link(\"./collection-hooks\", {\n  CollectionHooks: function (v) {\n    CollectionHooks = v;\n  }\n}, 1);\n\nvar isEmpty = function (a) {\n  return !Array.isArray(a) || !a.length;\n};\n\nCollectionHooks.defineAdvice('upsert', function (userId, _super, instance, aspectGroup, getTransform, args, suppressAspects) {\n  var _this = this;\n\n  args[0] = CollectionHooks.normalizeSelector(instance._getFindSelector(args));\n  var ctx = {\n    context: this,\n    _super: _super,\n    args: args\n  };\n\n  var _args = _slicedToArray(args, 4),\n      selector = _args[0],\n      mutator = _args[1],\n      options = _args[2],\n      callback = _args[3];\n\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  var async = typeof callback === 'function';\n  var docs;\n  var docIds;\n  var abort;\n  var prev = {};\n\n  if (!suppressAspects) {\n    if (!isEmpty(aspectGroup.upsert.before) || !isEmpty(aspectGroup.update.after)) {\n      docs = CollectionHooks.getDocs.call(this, instance, selector, options).fetch();\n      docIds = docs.map(function (doc) {\n        return doc._id;\n      });\n    } // copy originals for convenience for the 'after' pointcut\n\n\n    if (!isEmpty(aspectGroup.update.after)) {\n      if (aspectGroup.update.after.some(function (o) {\n        return o.options.fetchPrevious !== false;\n      }) && CollectionHooks.extendOptions(instance.hookOptions, {}, 'after', 'update').fetchPrevious !== false) {\n        prev.mutator = EJSON.clone(mutator);\n        prev.options = EJSON.clone(options);\n        prev.docs = {};\n        docs.forEach(function (doc) {\n          prev.docs[doc._id] = EJSON.clone(doc);\n        });\n      }\n    } // before\n\n\n    aspectGroup.upsert.before.forEach(function (o) {\n      var r = o.aspect.call(ctx, userId, selector, mutator, options);\n      if (r === false) abort = true;\n    });\n    if (abort) return {\n      numberAffected: 0\n    };\n  }\n\n  var afterUpdate = function (affected, err) {\n    if (!suppressAspects && !isEmpty(aspectGroup.update.after)) {\n      var fields = CollectionHooks.getFields(mutator);\n\n      var _docs = CollectionHooks.getDocs.call(_this, instance, {\n        _id: {\n          $in: docIds\n        }\n      }, options).fetch();\n\n      aspectGroup.update.after.forEach(function (o) {\n        _docs.forEach(function (doc) {\n          o.aspect.call(_objectSpread({\n            transform: getTransform(doc),\n            previous: prev.docs && prev.docs[doc._id],\n            affected: affected,\n            err: err\n          }, ctx), userId, doc, fields, prev.mutator, prev.options);\n        });\n      });\n    }\n  };\n\n  var afterInsert = function (_id, err) {\n    if (!suppressAspects && !isEmpty(aspectGroup.insert.after)) {\n      var doc = CollectionHooks.getDocs.call(_this, instance, {\n        _id: _id\n      }, selector, {}).fetch()[0]; // 3rd argument passes empty object which causes magic logic to imply limit:1\n\n      var lctx = _objectSpread({\n        transform: getTransform(doc),\n        _id: _id,\n        err: err\n      }, ctx);\n\n      aspectGroup.insert.after.forEach(function (o) {\n        o.aspect.call(lctx, userId, doc);\n      });\n    }\n  };\n\n  if (async) {\n    var wrappedCallback = function (err, ret) {\n      if (err || ret && ret.insertedId) {\n        // Send any errors to afterInsert\n        afterInsert(ret.insertedId, err);\n      } else {\n        afterUpdate(ret && ret.numberAffected, err); // Note that err can never reach here\n      }\n\n      return CollectionHooks.hookedOp(function () {\n        return callback.call(this, err, ret);\n      });\n    };\n\n    return CollectionHooks.directOp(function () {\n      return _super.call(_this, selector, mutator, options, wrappedCallback);\n    });\n  } else {\n    var ret = CollectionHooks.directOp(function () {\n      return _super.call(_this, selector, mutator, options, callback);\n    });\n\n    if (ret && ret.insertedId) {\n      afterInsert(ret.insertedId);\n    } else {\n      afterUpdate(ret && ret.numberAffected);\n    }\n\n    return ret;\n  }\n});\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n},\"users-compat.js\":function module(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/matb33_collection-hooks/users-compat.js                                                                    //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar Mongo;\nmodule.link(\"meteor/mongo\", {\n  Mongo: function (v) {\n    Mongo = v;\n  }\n}, 1);\nvar CollectionHooks;\nmodule.link(\"./collection-hooks\", {\n  CollectionHooks: function (v) {\n    CollectionHooks = v;\n  }\n}, 2);\n\nif (Meteor.users) {\n  // If Meteor.users has been instantiated, attempt to re-assign its prototype:\n  CollectionHooks.reassignPrototype(Meteor.users); // Next, give it the hook aspects:\n\n  CollectionHooks.extendCollectionInstance(Meteor.users, Mongo.Collection);\n}\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}}}}},{\n  \"extensions\": [\n    \".js\",\n    \".json\"\n  ]\n});\n\nvar exports = require(\"/node_modules/meteor/matb33:collection-hooks/client.js\");\n\n/* Exports */\nPackage._define(\"matb33:collection-hooks\", exports, {\n  CollectionHooks: CollectionHooks\n});\n\n})();\n","servePath":"/packages/matb33_collection-hooks.js","sourceMap":{"version":3,"sources":["packages/matb33:collection-hooks/client.js","packages/matb33:collection-hooks/advices.js","packages/matb33:collection-hooks/collection-hooks.js","packages/matb33:collection-hooks/find.js","packages/matb33:collection-hooks/findone.js","packages/matb33:collection-hooks/insert.js","packages/matb33:collection-hooks/remove.js","packages/matb33:collection-hooks/update.js","packages/matb33:collection-hooks/upsert.js","packages/matb33:collection-hooks/users-compat.js"],"names":["module","export","CollectionHooks","Meteor","link","v","Tracker","getUserId","userId","nonreactive","defaultUserId","_objectWithoutProperties","default","_objectSpread","_slicedToArray","Mongo","EJSON","LocalCollection","advices","defaults","before","insert","update","remove","upsert","find","findOne","all","after","directEnv","EnvironmentVariable","directOp","func","withValue","hookedOp","extendCollectionInstance","self","constructor","forEach","pointcut","Object","entries","method","advice","_ensure","_hookAspects","aspect","options","len","push","initOptions","replace","splice","hookOptions","clone","collection","isClient","_collection","_super","direct","args","prototype","apply","get","call","doc","_transform","d","defineAdvice","getAdvice","extendOptions","source","getDocs","selector","findOptions","transform","reactive","multi","limit","rest","assign","normalizeSelector","ObjectID","_id","getFields","mutator","fields","operators","op","params","includes","keys","field","indexOf","substring","reassignPrototype","instance","constr","hasSetPrototypeOf","setPrototypeOf","Collection","__proto__","wrapCollection","ns","as","_CollectionConstructor","_CollectionPrototype","_NewCollectionContructor","proto","ret","prop","Function","modify","_modify","aspects","getTransform","suppressAspects","ctx","context","_getFindSelector","_getFindOptions","abort","o","r","undefined","cursor","_typeof","callback","async","e","id","err","ops","_str","toString","lctx","wrappedCallback","obj","isEmpty","a","Array","isArray","length","docs","prev","fetch","result","docIds","map","some","fetchPrevious","affected","$in","previous","aspectGroup","numberAffected","afterUpdate","afterInsert","insertedId","users"],"mappings":"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","file":"/packages/matb33_collection-hooks.js","sourcesContent":["import { Meteor } from 'meteor/meteor'\nimport { Tracker } from 'meteor/tracker'\nimport { CollectionHooks } from './collection-hooks.js'\n\nimport './advices'\n\nCollectionHooks.getUserId = function getUserId () {\n  let userId\n\n  Tracker.nonreactive(() => {\n    userId = Meteor.userId && Meteor.userId()\n  })\n\n  if (userId == null) {\n    userId = CollectionHooks.defaultUserId\n  }\n\n  return userId\n}\n\nexport {\n  CollectionHooks\n}\n","import './insert.js'\nimport './update.js'\nimport './remove.js'\nimport './upsert.js'\nimport './find.js'\nimport './findone.js'\n\n// Load after all advices have been defined\nimport './users-compat.js'\n","import { Meteor } from 'meteor/meteor'\nimport { Mongo } from 'meteor/mongo'\nimport { EJSON } from 'meteor/ejson'\nimport { LocalCollection } from 'meteor/minimongo'\n\n// Relevant AOP terminology:\n// Aspect: User code that runs before/after (hook)\n// Advice: Wrapper code that knows when to call user code (aspects)\n// Pointcut: before/after\nconst advices = {}\n\nexport const CollectionHooks = {\n  defaults: {\n    before: { insert: {}, update: {}, remove: {}, upsert: {}, find: {}, findOne: {}, all: {} },\n    after: { insert: {}, update: {}, remove: {}, find: {}, findOne: {}, all: {} },\n    all: { insert: {}, update: {}, remove: {}, find: {}, findOne: {}, all: {} }\n  },\n  directEnv: new Meteor.EnvironmentVariable(),\n  directOp (func) {\n    return this.directEnv.withValue(true, func)\n  },\n  hookedOp (func) {\n    return this.directEnv.withValue(false, func)\n  }\n}\n\nCollectionHooks.extendCollectionInstance = function extendCollectionInstance (self, constructor) {\n  // Offer a public API to allow the user to define aspects\n  // Example: collection.before.insert(func);\n  ['before', 'after'].forEach(function (pointcut) {\n    Object.entries(advices).forEach(function ([method, advice]) {\n      if (advice === 'upsert' && pointcut === 'after') return\n\n      Meteor._ensure(self, pointcut, method)\n      Meteor._ensure(self, '_hookAspects', method)\n\n      self._hookAspects[method][pointcut] = []\n      self[pointcut][method] = function (aspect, options) {\n        const len = self._hookAspects[method][pointcut].push({\n          aspect,\n          options: CollectionHooks.initOptions(options, pointcut, method)\n        })\n\n        return {\n          replace (aspect, options) {\n            self._hookAspects[method][pointcut].splice(len - 1, 1, {\n              aspect,\n              options: CollectionHooks.initOptions(options, pointcut, method)\n            })\n          },\n          remove () {\n            self._hookAspects[method][pointcut].splice(len - 1, 1)\n          }\n        }\n      }\n    })\n  })\n\n  // Offer a publicly accessible object to allow the user to define\n  // collection-wide hook options.\n  // Example: collection.hookOptions.after.update = {fetchPrevious: false};\n  self.hookOptions = EJSON.clone(CollectionHooks.defaults)\n\n  // Wrap mutator methods, letting the defined advice do the work\n  Object.entries(advices).forEach(function ([method, advice]) {\n    const collection = Meteor.isClient || method === 'upsert' ? self : self._collection\n\n    // Store a reference to the original mutator method\n    const _super = collection[method]\n\n    Meteor._ensure(self, 'direct', method)\n    self.direct[method] = function (...args) {\n      return CollectionHooks.directOp(function () {\n        return constructor.prototype[method].apply(self, args)\n      })\n    }\n\n    collection[method] = function (...args) {\n      if (CollectionHooks.directEnv.get() === true) {\n        return _super.apply(collection, args)\n      }\n\n      // NOTE: should we decide to force `update` with `{upsert:true}` to use\n      // the `upsert` hooks, this is what will accomplish it. It's important to\n      // realize that Meteor won't distinguish between an `update` and an\n      // `insert` though, so we'll end up with `after.update` getting called\n      // even on an `insert`. That's why we've chosen to disable this for now.\n      // if (method === \"update\" && Object(args[2]) === args[2] && args[2].upsert) {\n      //   method = \"upsert\";\n      //   advice = CollectionHooks.getAdvice(method);\n      // }\n\n      return advice.call(this,\n        CollectionHooks.getUserId(),\n        _super,\n        self,\n        method === 'upsert' ? {\n          insert: self._hookAspects.insert || {},\n          update: self._hookAspects.update || {},\n          upsert: self._hookAspects.upsert || {}\n        } : self._hookAspects[method] || {},\n        function (doc) {\n          return (\n            typeof self._transform === 'function'\n              ? function (d) { return self._transform(d || doc) }\n              : function (d) { return d || doc }\n          )\n        },\n        args,\n        false\n      )\n    }\n  })\n}\n\nCollectionHooks.defineAdvice = (method, advice) => {\n  advices[method] = advice\n}\n\nCollectionHooks.getAdvice = method => advices[method]\n\nCollectionHooks.initOptions = (options, pointcut, method) =>\n  CollectionHooks.extendOptions(CollectionHooks.defaults, options, pointcut, method)\n\nCollectionHooks.extendOptions = (source, options, pointcut, method) =>\n  ({ ...options, ...source.all.all, ...source[pointcut].all, ...source.all[method], ...source[pointcut][method] })\n\nCollectionHooks.getDocs = function getDocs (collection, selector, options) {\n  const findOptions = { transform: null, reactive: false } // added reactive: false\n\n  /*\n  // No \"fetch\" support at this time.\n  if (!this._validators.fetchAllFields) {\n    findOptions.fields = {};\n    this._validators.fetch.forEach(function(fieldName) {\n      findOptions.fields[fieldName] = 1;\n    });\n  }\n  */\n\n  // Bit of a magic condition here... only \"update\" passes options, so this is\n  // only relevant to when update calls getDocs:\n  if (options) {\n    // This was added because in our case, we are potentially iterating over\n    // multiple docs. If multi isn't enabled, force a limit (almost like\n    // findOne), as the default for update without multi enabled is to affect\n    // only the first matched document:\n    if (!options.multi) {\n      findOptions.limit = 1\n    }\n    const { multi, upsert, ...rest } = options\n    Object.assign(findOptions, rest)\n  }\n\n  // Unlike validators, we iterate over multiple docs, so use\n  // find instead of findOne:\n  return collection.find(selector, findOptions)\n}\n\n// This function normalizes the selector (converting it to an Object)\nCollectionHooks.normalizeSelector = function (selector) {\n  if (typeof selector === 'string' || (selector && selector.constructor === Mongo.ObjectID)) {\n    return {\n      _id: selector\n    }\n  } else {\n    return selector\n  }\n}\n\n// This function contains a snippet of code pulled and modified from:\n// ~/.meteor/packages/mongo-livedata/collection.js\n// It's contained in these utility functions to make updates easier for us in\n// case this code changes.\nCollectionHooks.getFields = function getFields (mutator) {\n  // compute modified fields\n  const fields = []\n  // ====ADDED START=======================\n  const operators = [\n    '$addToSet',\n    '$bit',\n    '$currentDate',\n    '$inc',\n    '$max',\n    '$min',\n    '$pop',\n    '$pull',\n    '$pullAll',\n    '$push',\n    '$rename',\n    '$set',\n    '$unset'\n  ]\n  // ====ADDED END=========================\n\n  Object.entries(mutator).forEach(function ([op, params]) {\n    // ====ADDED START=======================\n    if (operators.includes(op)) {\n    // ====ADDED END=========================\n      Object.keys(params).forEach(function (field) {\n        // treat dotted fields as if they are replacing their\n        // top-level part\n        if (field.indexOf('.') !== -1) {\n          field = field.substring(0, field.indexOf('.'))\n        }\n\n        // record the field we are trying to change\n        if (!fields.includes(field)) {\n          fields.push(field)\n        }\n      })\n      // ====ADDED START=======================\n    } else {\n      fields.push(op)\n    }\n    // ====ADDED END=========================\n  })\n\n  return fields\n}\n\nCollectionHooks.reassignPrototype = function reassignPrototype (instance, constr) {\n  const hasSetPrototypeOf = typeof Object.setPrototypeOf === 'function'\n  constr = constr || Mongo.Collection\n\n  // __proto__ is not available in < IE11\n  // Note: Assigning a prototype dynamically has performance implications\n  if (hasSetPrototypeOf) {\n    Object.setPrototypeOf(instance, constr.prototype)\n  } else if (instance.__proto__) { // eslint-disable-line no-proto\n    instance.__proto__ = constr.prototype // eslint-disable-line no-proto\n  }\n}\n\nCollectionHooks.wrapCollection = function wrapCollection (ns, as) {\n  if (!as._CollectionConstructor) as._CollectionConstructor = as.Collection\n  if (!as._CollectionPrototype) as._CollectionPrototype = new as.Collection(null)\n\n  const constructor = ns._NewCollectionContructor || as._CollectionConstructor\n  const proto = as._CollectionPrototype\n\n  ns.Collection = function (...args) {\n    const ret = constructor.apply(this, args)\n    CollectionHooks.extendCollectionInstance(this, constructor)\n    return ret\n  }\n  // Retain a reference to the new constructor to allow further wrapping.\n  ns._NewCollectionContructor = ns.Collection\n\n  ns.Collection.prototype = proto\n  ns.Collection.prototype.constructor = ns.Collection\n\n  for (const prop of Object.keys(constructor)) {\n    ns.Collection[prop] = constructor[prop]\n  }\n\n  // Meteor overrides the apply method which is copied from the constructor in the loop above. Replace it with the\n  // default method which we need if we were to further wrap ns.Collection.\n  ns.Collection.apply = Function.prototype.apply\n}\n\nCollectionHooks.modify = LocalCollection._modify\n\nif (typeof Mongo !== 'undefined') {\n  CollectionHooks.wrapCollection(Meteor, Mongo)\n  CollectionHooks.wrapCollection(Mongo, Mongo)\n} else {\n  CollectionHooks.wrapCollection(Meteor, Meteor)\n}\n","import { CollectionHooks } from './collection-hooks'\n\nCollectionHooks.defineAdvice('find', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  const ctx = { context: this, _super, args }\n  const selector = CollectionHooks.normalizeSelector(instance._getFindSelector(args))\n  const options = instance._getFindOptions(args)\n  let abort\n  // before\n  if (!suppressAspects) {\n    aspects.before.forEach((o) => {\n      const r = o.aspect.call(ctx, userId, selector, options)\n      if (r === false) abort = true\n    })\n\n    if (abort) return instance.find(undefined)\n  }\n\n  const after = (cursor) => {\n    if (!suppressAspects) {\n      aspects.after.forEach((o) => {\n        o.aspect.call(ctx, userId, selector, options, cursor)\n      })\n    }\n  }\n\n  const ret = _super.call(this, selector, options)\n  after(ret)\n\n  return ret\n})\n","import { CollectionHooks } from './collection-hooks'\n\nCollectionHooks.defineAdvice('findOne', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  const ctx = { context: this, _super, args }\n  const selector = CollectionHooks.normalizeSelector(instance._getFindSelector(args))\n  const options = instance._getFindOptions(args)\n  let abort\n\n  // before\n  if (!suppressAspects) {\n    aspects.before.forEach((o) => {\n      const r = o.aspect.call(ctx, userId, selector, options)\n      if (r === false) abort = true\n    })\n\n    if (abort) return\n  }\n\n  function after (doc) {\n    if (!suppressAspects) {\n      aspects.after.forEach((o) => {\n        o.aspect.call(ctx, userId, selector, options, doc)\n      })\n    }\n  }\n\n  const ret = _super.call(this, selector, options)\n  after(ret)\n\n  return ret\n})\n","import { EJSON } from 'meteor/ejson'\nimport { Mongo } from 'meteor/mongo'\nimport { CollectionHooks } from './collection-hooks'\n\nCollectionHooks.defineAdvice('insert', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  const ctx = { context: this, _super, args }\n  let [doc, callback] = args\n  const async = typeof callback === 'function'\n  let abort\n  let ret\n\n  // before\n  if (!suppressAspects) {\n    try {\n      aspects.before.forEach((o) => {\n        const r = o.aspect.call({ transform: getTransform(doc), ...ctx }, userId, doc)\n        if (r === false) abort = true\n      })\n\n      if (abort) return\n    } catch (e) {\n      if (async) return callback.call(this, e)\n      throw e\n    }\n  }\n\n  const after = (id, err) => {\n    if (id) {\n      // In some cases (namely Meteor.users on Meteor 1.4+), the _id property\n      // is a raw mongo _id object. We need to extract the _id from this object\n      if (typeof id === 'object' && id.ops) {\n        // If _str then collection is using Mongo.ObjectID as ids\n        if (doc._id._str) {\n          id = new Mongo.ObjectID(doc._id._str.toString())\n        } else {\n          id = id.ops && id.ops[0] && id.ops[0]._id\n        }\n      }\n      doc = EJSON.clone(doc)\n      doc._id = id\n    }\n    if (!suppressAspects) {\n      const lctx = { transform: getTransform(doc), _id: id, err, ...ctx }\n      aspects.after.forEach((o) => {\n        o.aspect.call(lctx, userId, doc)\n      })\n    }\n    return id\n  }\n\n  if (async) {\n    const wrappedCallback = function (err, obj, ...args) {\n      after((obj && obj[0] && obj[0]._id) || obj, err)\n      return callback.call(this, err, obj, ...args)\n    }\n    return _super.call(this, doc, wrappedCallback)\n  } else {\n    ret = _super.call(this, doc, callback)\n    return after((ret && ret[0] && ret[0]._id) || ret)\n  }\n})\n","import { EJSON } from 'meteor/ejson'\nimport { CollectionHooks } from './collection-hooks'\n\nconst isEmpty = a => !Array.isArray(a) || !a.length\n\nCollectionHooks.defineAdvice('remove', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  const ctx = { context: this, _super, args }\n  const [selector, callback] = args\n  const async = typeof callback === 'function'\n  let docs\n  let abort\n  const prev = []\n\n  if (!suppressAspects) {\n    try {\n      if (!isEmpty(aspects.before) || !isEmpty(aspects.after)) {\n        docs = CollectionHooks.getDocs.call(this, instance, selector).fetch()\n      }\n\n      // copy originals for convenience for the 'after' pointcut\n      if (!isEmpty(aspects.after)) {\n        docs.forEach(doc => prev.push(EJSON.clone(doc)))\n      }\n\n      // before\n      aspects.before.forEach((o) => {\n        docs.forEach((doc) => {\n          const r = o.aspect.call({ transform: getTransform(doc), ...ctx }, userId, doc)\n          if (r === false) abort = true\n        })\n      })\n\n      if (abort) return 0\n    } catch (e) {\n      if (async) return callback.call(this, e)\n      throw e\n    }\n  }\n\n  function after (err) {\n    if (!suppressAspects) {\n      aspects.after.forEach((o) => {\n        prev.forEach((doc) => {\n          o.aspect.call({ transform: getTransform(doc), err, ...ctx }, userId, doc)\n        })\n      })\n    }\n  }\n\n  if (async) {\n    const wrappedCallback = function (err, ...args) {\n      after(err)\n      return callback.call(this, err, ...args)\n    }\n    return _super.call(this, selector, wrappedCallback)\n  } else {\n    const result = _super.call(this, selector, callback)\n    after()\n    return result\n  }\n})\n","import { EJSON } from 'meteor/ejson'\nimport { CollectionHooks } from './collection-hooks'\n\nconst isEmpty = a => !Array.isArray(a) || !a.length\n\nCollectionHooks.defineAdvice('update', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  const ctx = { context: this, _super, args }\n  let [selector, mutator, options, callback] = args\n  if (typeof options === 'function') {\n    callback = options\n    options = {}\n  }\n  const async = typeof callback === 'function'\n  let docs\n  let docIds\n  let fields\n  let abort\n  const prev = {}\n\n  if (!suppressAspects) {\n    try {\n      if (!isEmpty(aspects.before) || !isEmpty(aspects.after)) {\n        fields = CollectionHooks.getFields(mutator)\n        docs = CollectionHooks.getDocs.call(this, instance, selector, options).fetch()\n        docIds = docs.map(doc => doc._id)\n      }\n\n      // copy originals for convenience for the 'after' pointcut\n      if (!isEmpty(aspects.after)) {\n        prev.mutator = EJSON.clone(mutator)\n        prev.options = EJSON.clone(options)\n        if (\n          aspects.after.some(o => o.options.fetchPrevious !== false) &&\n          CollectionHooks.extendOptions(instance.hookOptions, {}, 'after', 'update').fetchPrevious !== false\n        ) {\n          prev.docs = {}\n          docs.forEach((doc) => {\n            prev.docs[doc._id] = EJSON.clone(doc)\n          })\n        }\n      }\n\n      // before\n      aspects.before.forEach(function (o) {\n        docs.forEach(function (doc) {\n          const r = o.aspect.call({ transform: getTransform(doc), ...ctx }, userId, doc, fields, mutator, options)\n          if (r === false) abort = true\n        })\n      })\n\n      if (abort) return 0\n    } catch (e) {\n      if (async) return callback.call(this, e)\n      throw e\n    }\n  }\n\n  const after = (affected, err) => {\n    if (!suppressAspects && !isEmpty(aspects.after)) {\n      const fields = CollectionHooks.getFields(mutator)\n      const docs = CollectionHooks.getDocs.call(this, instance, { _id: { $in: docIds } }, options).fetch()\n\n      aspects.after.forEach((o) => {\n        docs.forEach((doc) => {\n          o.aspect.call({\n            transform: getTransform(doc),\n            previous: prev.docs && prev.docs[doc._id],\n            affected,\n            err,\n            ...ctx\n          }, userId, doc, fields, prev.mutator, prev.options)\n        })\n      })\n    }\n  }\n\n  if (async) {\n    const wrappedCallback = function (err, affected, ...args) {\n      after(affected, err)\n      return callback.call(this, err, affected, ...args)\n    }\n    return _super.call(this, selector, mutator, options, wrappedCallback)\n  } else {\n    const affected = _super.call(this, selector, mutator, options, callback)\n    after(affected)\n    return affected\n  }\n})\n","import { EJSON } from 'meteor/ejson'\nimport { CollectionHooks } from './collection-hooks'\n\nconst isEmpty = a => !Array.isArray(a) || !a.length\n\nCollectionHooks.defineAdvice('upsert', function (userId, _super, instance, aspectGroup, getTransform, args, suppressAspects) {\n  args[0] = CollectionHooks.normalizeSelector(instance._getFindSelector(args))\n\n  const ctx = { context: this, _super, args }\n  let [selector, mutator, options, callback] = args\n  if (typeof options === 'function') {\n    callback = options\n    options = {}\n  }\n\n  const async = typeof callback === 'function'\n  let docs\n  let docIds\n  let abort\n  const prev = {}\n\n  if (!suppressAspects) {\n    if (!isEmpty(aspectGroup.upsert.before) || !isEmpty(aspectGroup.update.after)) {\n      docs = CollectionHooks.getDocs.call(this, instance, selector, options).fetch()\n      docIds = docs.map(doc => doc._id)\n    }\n\n    // copy originals for convenience for the 'after' pointcut\n    if (!isEmpty(aspectGroup.update.after)) {\n      if (aspectGroup.update.after.some(o => o.options.fetchPrevious !== false) &&\n        CollectionHooks.extendOptions(instance.hookOptions, {}, 'after', 'update').fetchPrevious !== false) {\n        prev.mutator = EJSON.clone(mutator)\n        prev.options = EJSON.clone(options)\n\n        prev.docs = {}\n        docs.forEach((doc) => {\n          prev.docs[doc._id] = EJSON.clone(doc)\n        })\n      }\n    }\n\n    // before\n    aspectGroup.upsert.before.forEach((o) => {\n      const r = o.aspect.call(ctx, userId, selector, mutator, options)\n      if (r === false) abort = true\n    })\n\n    if (abort) return { numberAffected: 0 }\n  }\n\n  const afterUpdate = (affected, err) => {\n    if (!suppressAspects && !isEmpty(aspectGroup.update.after)) {\n      const fields = CollectionHooks.getFields(mutator)\n      const docs = CollectionHooks.getDocs.call(this, instance, { _id: { $in: docIds } }, options).fetch()\n\n      aspectGroup.update.after.forEach((o) => {\n        docs.forEach((doc) => {\n          o.aspect.call({\n            transform: getTransform(doc),\n            previous: prev.docs && prev.docs[doc._id],\n            affected,\n            err,\n            ...ctx\n          }, userId, doc, fields, prev.mutator, prev.options)\n        })\n      })\n    }\n  }\n\n  const afterInsert = (_id, err) => {\n    if (!suppressAspects && !isEmpty(aspectGroup.insert.after)) {\n      const doc = CollectionHooks.getDocs.call(this, instance, { _id }, selector, {}).fetch()[0] // 3rd argument passes empty object which causes magic logic to imply limit:1\n      const lctx = { transform: getTransform(doc), _id, err, ...ctx }\n\n      aspectGroup.insert.after.forEach((o) => {\n        o.aspect.call(lctx, userId, doc)\n      })\n    }\n  }\n\n  if (async) {\n    const wrappedCallback = function (err, ret) {\n      if (err || (ret && ret.insertedId)) {\n        // Send any errors to afterInsert\n        afterInsert(ret.insertedId, err)\n      } else {\n        afterUpdate(ret && ret.numberAffected, err) // Note that err can never reach here\n      }\n\n      return CollectionHooks.hookedOp(function () {\n        return callback.call(this, err, ret)\n      })\n    }\n\n    return CollectionHooks.directOp(() => _super.call(this, selector, mutator, options, wrappedCallback))\n  } else {\n    const ret = CollectionHooks.directOp(() => _super.call(this, selector, mutator, options, callback))\n\n    if (ret && ret.insertedId) {\n      afterInsert(ret.insertedId)\n    } else {\n      afterUpdate(ret && ret.numberAffected)\n    }\n\n    return ret\n  }\n})\n","import { Meteor } from 'meteor/meteor'\nimport { Mongo } from 'meteor/mongo'\nimport { CollectionHooks } from './collection-hooks'\n\nif (Meteor.users) {\n  // If Meteor.users has been instantiated, attempt to re-assign its prototype:\n  CollectionHooks.reassignPrototype(Meteor.users)\n\n  // Next, give it the hook aspects:\n  CollectionHooks.extendCollectionInstance(Meteor.users, Mongo.Collection)\n}\n"]}}]