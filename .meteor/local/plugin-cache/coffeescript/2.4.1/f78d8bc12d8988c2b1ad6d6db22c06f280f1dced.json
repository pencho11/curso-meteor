{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"C:\\Users\\RUBEN\\Desktop\\meteor-vue\\packages\\peerlibrary:middleware\\server.coffee","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.windows.x86_64"},"sourceFileName":"packages/peerlibrary:middleware/server.coffee","filename":"C:\\Users\\RUBEN\\Desktop\\meteor-vue\\packages\\peerlibrary:middleware\\server.coffee","passPerPreset":false,"envName":"development","cwd":"C:\\Users\\RUBEN\\Desktop\\meteor-vue","root":"C:\\Users\\RUBEN\\Desktop\\meteor-vue","plugins":[{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"C:\\Users\\RUBEN\\Desktop\\meteor-vue\\packages\\peerlibrary:middleware\\server.coffee","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/peerlibrary:middleware/server.coffee"}},"code":"module.export({\n  PublishEndpoint: () => PublishEndpoint,\n  PublishMiddleware: () => PublishMiddleware\n});\n\nlet _;\n\nmodule.link(\"meteor/underscore\", {\n  _(v) {\n    _ = v;\n  }\n\n}, 0);\nlet Fiber;\nmodule.link(\"fibers\", {\n  default(v) {\n    Fiber = v;\n  }\n\n}, 1);\nvar MiddlewarePublish,\n    isInsideNoYieldsAllowed,\n    savedYield,\n    hasProp = {}.hasOwnProperty;\nsavedYield = Fiber.yield; // When inside Meteor._noYieldsAllowed Fiber.yield is overridden with\n// a function which throws an exception, so is not savedYield anymore.\n// Afterwards Fiber.yield is restored back to savedYield.\n\nisInsideNoYieldsAllowed = function () {\n  return Fiber.yield !== savedYield;\n};\n\nMiddlewarePublish = class MiddlewarePublish {\n  constructor(publish1) {\n    var key, ref, value;\n    this.publish = publish1; // We store those methods at construction time because\n    // we override them later on publish object.\n\n    this._publishAdded = this.publish.added.bind(this.publish);\n    this._publishChanged = this.publish.changed.bind(this.publish);\n    this._publishRemoved = this.publish.removed.bind(this.publish);\n    this._publishReady = this.publish.ready.bind(this.publish);\n    this._publishStop = this.publish.stop.bind(this.publish);\n    this._publishError = this.publish.error.bind(this.publish);\n    ref = this.publish;\n\n    for (key in ref) {\n      if (!hasProp.call(ref, key)) continue;\n      value = ref[key];\n\n      if (key !== 'added' && key !== 'changed' && key !== 'removed' && key !== 'ready' && key !== 'stop' && key !== 'error') {\n        this[key] = value;\n      }\n    }\n  }\n\n  added(...args) {\n    return this._publishAdded(...args);\n  }\n\n  changed(...args) {\n    return this._publishChanged(...args);\n  }\n\n  removed(...args) {\n    return this._publishRemoved(...args);\n  }\n\n  ready(...args) {\n    return this._publishReady(...args);\n  }\n\n  stop(...args) {\n    return this._publishStop(...args);\n  }\n\n  error(...args) {\n    return this._publishError(...args);\n  }\n\n};\nvar PublishEndpoint = class PublishEndpoint {\n  constructor(options, publishFunction) {\n    var self;\n    this.options = options;\n    this.publishFunction = publishFunction; // To pass null (autopublish) or string directly for name\n\n    if (this.options === null || _.isString(this.options)) {\n      this.options = {\n        name: this.options\n      };\n    }\n\n    this.middlewares = [];\n    self = this;\n    Meteor.publish(this.options.name, function (...args) {\n      var publish, state;\n      publish = this;\n      state = {};\n\n      publish.params = function () {\n        return args;\n      };\n\n      publish.set = function (key, value) {\n        return state[key] = value;\n      };\n\n      publish.get = function (key) {\n        return state[key];\n      };\n\n      return self.publish(self.middlewares, publish);\n    });\n  }\n\n  publish(middlewares, publish) {\n    var latestMiddleware, midlewarePublish, otherMiddlewares, publishRemoved;\n\n    if (middlewares.length) {\n      latestMiddleware = middlewares[middlewares.length - 1];\n      otherMiddlewares = middlewares.slice(0, middlewares.length - 1);\n      midlewarePublish = new MiddlewarePublish(publish);\n\n      publish.added = function (collection, id, fields) {\n        return latestMiddleware.added(midlewarePublish, collection, id, fields);\n      };\n\n      publish.changed = function (collection, id, fields) {\n        return latestMiddleware.changed(midlewarePublish, collection, id, fields);\n      };\n\n      publishRemoved = publish.removed;\n\n      publish.removed = function (collection, id) {\n        // When unsubscribing, Meteor removes all documents so this callback is called\n        // inside Meteor._noYieldsAllowed which means inside the callback no function\n        // which calls yield can be called. Because this is often not true, in that\n        // special case we are not going through middlewares but are directly calling\n        // original removed callback.\n        if (isInsideNoYieldsAllowed()) {\n          return publishRemoved.call(publish, collection, id);\n        } else {\n          return latestMiddleware.removed(midlewarePublish, collection, id);\n        }\n      };\n\n      publish.ready = function () {\n        return latestMiddleware.onReady(midlewarePublish);\n      };\n\n      publish.stop = function () {\n        return latestMiddleware.onStop(midlewarePublish);\n      };\n\n      publish.error = function (error) {\n        return latestMiddleware.onError(midlewarePublish, error);\n      };\n\n      return this.publish(otherMiddlewares, publish);\n    } else {\n      return this.publishFunction.apply(publish, publish.params());\n    }\n  }\n\n  use(middleware) {\n    if (!(middleware instanceof PublishMiddleware)) {\n      throw new Error(`Middleware '${middleware}' is not an instance of a PublishMiddleware class`);\n    }\n\n    return this.middlewares.push(middleware);\n  }\n\n};\nvar PublishMiddleware = class PublishMiddleware {\n  added(publish, collection, id, fields) {\n    return publish.added(collection, id, fields);\n  }\n\n  changed(publish, collection, id, fields) {\n    return publish.changed(collection, id, fields);\n  }\n\n  removed(publish, collection, id) {\n    return publish.removed(collection, id);\n  }\n\n  onReady(publish) {\n    return publish.ready();\n  }\n\n  onStop(publish) {\n    return publish.stop();\n  }\n\n  onError(publish, error) {\n    return publish.error(error);\n  }\n\n};","map":{"version":3,"sources":["packages/peerlibrary:middleware/server.coffee"],"names":["module","export","PublishEndpoint","PublishMiddleware","_","link","v","Fiber","default","MiddlewarePublish","isInsideNoYieldsAllowed","savedYield","hasProp","hasOwnProperty","yield","constructor","publish1","key","ref","value","publish","_publishAdded","added","bind","_publishChanged","changed","_publishRemoved","removed","_publishReady","ready","_publishStop","stop","_publishError","error","call","args","options","publishFunction","self","isString","name","middlewares","Meteor","state","params","set","get","latestMiddleware","midlewarePublish","otherMiddlewares","publishRemoved","length","slice","collection","id","fields","onReady","onStop","onError","apply","use","middleware","Error","push"],"mappings":"AAAAA,MAAM,CAACC,MAAP,CAAc;AAACC,EAAAA,eAAe,EAAC,MAAIA,eAArB;AAAqCC,EAAAA,iBAAiB,EAAC,MAAIA;AAA3D,CAAd;;AAA6F,IAAIC,CAAJ;;AAAMJ,MAAM,CAACK,IAAP,CAAY,mBAAZ,EAAgC;AAACD,EAAAA,CAAC,CAACE,CAAD,EAAG;AAACF,IAAAA,CAAC,GAACE,CAAF;AAAI;;AAAV,CAAhC,EAA4C,CAA5C;AAA+C,IAAIC,KAAJ;AAAUP,MAAM,CAACK,IAAP,CAAY,QAAZ,EAAqB;AAACG,EAAAA,OAAO,CAACF,CAAD,EAAG;AAACC,IAAAA,KAAK,GAACD,CAAN;AAAQ;;AAApB,CAArB,EAA2C,CAA3C;AAA5J,IAAIG,iBAAJ;AAAA,IAAuBC,uBAAvB;AAAA,IAAgDC,UAAhD;AAAA,IACEC,OAAO,GAAG,GAAGC,cADf;AASAF,UAAU,GAAGJ,KAAK,CAACO,KAAnB,C,CAEA;AACA;AACA;;AACAJ,uBAAuB,GAAG,YAAW;AACnC,SAAOH,KAAK,CAACO,KAAN,KAAgBH,UAAvB;AACD,CAFD;;AAIAF,iBAAiB,GAAG,MAAMA,iBAAN,CAAwB;AAC1CM,EAAAA,WAAW,CAACC,QAAD,EAAW;AACpB,QAAIC,GAAJ,EAASC,GAAT,EAAcC,KAAd;AACA,SAAKC,OAAL,GAAeJ,QAAf,CAFoB,CAGpB;AACA;;AACA,SAAKK,aAAL,GAAqB,KAAKD,OAAL,CAAaE,KAAb,CAAmBC,IAAnB,CAAwB,KAAKH,OAA7B,CAArB;AACA,SAAKI,eAAL,GAAuB,KAAKJ,OAAL,CAAaK,OAAb,CAAqBF,IAArB,CAA0B,KAAKH,OAA/B,CAAvB;AACA,SAAKM,eAAL,GAAuB,KAAKN,OAAL,CAAaO,OAAb,CAAqBJ,IAArB,CAA0B,KAAKH,OAA/B,CAAvB;AACA,SAAKQ,aAAL,GAAqB,KAAKR,OAAL,CAAaS,KAAb,CAAmBN,IAAnB,CAAwB,KAAKH,OAA7B,CAArB;AACA,SAAKU,YAAL,GAAoB,KAAKV,OAAL,CAAaW,IAAb,CAAkBR,IAAlB,CAAuB,KAAKH,OAA5B,CAApB;AACA,SAAKY,aAAL,GAAqB,KAAKZ,OAAL,CAAaa,KAAb,CAAmBV,IAAnB,CAAwB,KAAKH,OAA7B,CAArB;AACAF,IAAAA,GAAG,GAAG,KAAKE,OAAX;;AACA,SAAKH,GAAL,IAAYC,GAAZ,EAAiB;AACf,UAAI,CAACN,OAAO,CAACsB,IAAR,CAAahB,GAAb,EAAkBD,GAAlB,CAAL,EAA6B;AAC7BE,MAAAA,KAAK,GAAGD,GAAG,CAACD,GAAD,CAAX;;AACA,UAAIA,GAAG,KAAK,OAAR,IAAmBA,GAAG,KAAK,SAA3B,IAAwCA,GAAG,KAAK,SAAhD,IAA6DA,GAAG,KAAK,OAArE,IAAgFA,GAAG,KAAK,MAAxF,IAAkGA,GAAG,KAAK,OAA9G,EAAuH;AACrH,aAAKA,GAAL,IAAYE,KAAZ;AACD;AACF;AACF;;AAEDG,EAAAA,KAAK,CAAC,GAAGa,IAAJ,EAAU;AACb,WAAO,KAAKd,aAAL,CAAmB,GAAGc,IAAtB,CAAP;AACD;;AAEDV,EAAAA,OAAO,CAAC,GAAGU,IAAJ,EAAU;AACf,WAAO,KAAKX,eAAL,CAAqB,GAAGW,IAAxB,CAAP;AACD;;AAEDR,EAAAA,OAAO,CAAC,GAAGQ,IAAJ,EAAU;AACf,WAAO,KAAKT,eAAL,CAAqB,GAAGS,IAAxB,CAAP;AACD;;AAEDN,EAAAA,KAAK,CAAC,GAAGM,IAAJ,EAAU;AACb,WAAO,KAAKP,aAAL,CAAmB,GAAGO,IAAtB,CAAP;AACD;;AAEDJ,EAAAA,IAAI,CAAC,GAAGI,IAAJ,EAAU;AACZ,WAAO,KAAKL,YAAL,CAAkB,GAAGK,IAArB,CAAP;AACD;;AAEDF,EAAAA,KAAK,CAAC,GAAGE,IAAJ,EAAU;AACb,WAAO,KAAKH,aAAL,CAAmB,GAAGG,IAAtB,CAAP;AACD;;AA5CyC,CAA5C;AAgDO,IAAIjC,eAAe,GAAG,MAAMA,eAAN,CAAsB;AACjDa,EAAAA,WAAW,CAACqB,OAAD,EAAUC,eAAV,EAA2B;AACpC,QAAIC,IAAJ;AACA,SAAKF,OAAL,GAAeA,OAAf;AACA,SAAKC,eAAL,GAAuBA,eAAvB,CAHoC,CAIpC;;AACA,QAAI,KAAKD,OAAL,KAAiB,IAAjB,IAAyBhC,CAAC,CAACmC,QAAF,CAAW,KAAKH,OAAhB,CAA7B,EAAuD;AACrD,WAAKA,OAAL,GAAe;AACbI,QAAAA,IAAI,EAAE,KAAKJ;AADE,OAAf;AAGD;;AACD,SAAKK,WAAL,GAAmB,EAAnB;AACAH,IAAAA,IAAI,GAAG,IAAP;AACAI,IAAAA,MAAM,CAACtB,OAAP,CAAe,KAAKgB,OAAL,CAAaI,IAA5B,EAAkC,UAAS,GAAGL,IAAZ,EAAkB;AAClD,UAAIf,OAAJ,EAAauB,KAAb;AACAvB,MAAAA,OAAO,GAAG,IAAV;AACAuB,MAAAA,KAAK,GAAG,EAAR;;AACAvB,MAAAA,OAAO,CAACwB,MAAR,GAAiB,YAAW;AAC1B,eAAOT,IAAP;AACD,OAFD;;AAGAf,MAAAA,OAAO,CAACyB,GAAR,GAAc,UAAS5B,GAAT,EAAcE,KAAd,EAAqB;AACjC,eAAOwB,KAAK,CAAC1B,GAAD,CAAL,GAAaE,KAApB;AACD,OAFD;;AAGAC,MAAAA,OAAO,CAAC0B,GAAR,GAAc,UAAS7B,GAAT,EAAc;AAC1B,eAAO0B,KAAK,CAAC1B,GAAD,CAAZ;AACD,OAFD;;AAGA,aAAOqB,IAAI,CAAClB,OAAL,CAAakB,IAAI,CAACG,WAAlB,EAA+BrB,OAA/B,CAAP;AACD,KAdD;AAeD;;AAEDA,EAAAA,OAAO,CAACqB,WAAD,EAAcrB,OAAd,EAAuB;AAC5B,QAAI2B,gBAAJ,EAAsBC,gBAAtB,EAAwCC,gBAAxC,EAA0DC,cAA1D;;AACA,QAAIT,WAAW,CAACU,MAAhB,EAAwB;AACtBJ,MAAAA,gBAAgB,GAAGN,WAAW,CAACA,WAAW,CAACU,MAAZ,GAAqB,CAAtB,CAA9B;AACAF,MAAAA,gBAAgB,GAAGR,WAAW,CAACW,KAAZ,CAAkB,CAAlB,EAAqBX,WAAW,CAACU,MAAZ,GAAqB,CAA1C,CAAnB;AACAH,MAAAA,gBAAgB,GAAG,IAAIvC,iBAAJ,CAAsBW,OAAtB,CAAnB;;AACAA,MAAAA,OAAO,CAACE,KAAR,GAAgB,UAAS+B,UAAT,EAAqBC,EAArB,EAAyBC,MAAzB,EAAiC;AAC/C,eAAOR,gBAAgB,CAACzB,KAAjB,CAAuB0B,gBAAvB,EAAyCK,UAAzC,EAAqDC,EAArD,EAAyDC,MAAzD,CAAP;AACD,OAFD;;AAGAnC,MAAAA,OAAO,CAACK,OAAR,GAAkB,UAAS4B,UAAT,EAAqBC,EAArB,EAAyBC,MAAzB,EAAiC;AACjD,eAAOR,gBAAgB,CAACtB,OAAjB,CAAyBuB,gBAAzB,EAA2CK,UAA3C,EAAuDC,EAAvD,EAA2DC,MAA3D,CAAP;AACD,OAFD;;AAGAL,MAAAA,cAAc,GAAG9B,OAAO,CAACO,OAAzB;;AACAP,MAAAA,OAAO,CAACO,OAAR,GAAkB,UAAS0B,UAAT,EAAqBC,EAArB,EAAyB;AACzC;AACA;AACA;AACA;AACA;AACA,YAAI5C,uBAAuB,EAA3B,EAA+B;AAC7B,iBAAOwC,cAAc,CAAChB,IAAf,CAAoBd,OAApB,EAA6BiC,UAA7B,EAAyCC,EAAzC,CAAP;AACD,SAFD,MAEO;AACL,iBAAOP,gBAAgB,CAACpB,OAAjB,CAAyBqB,gBAAzB,EAA2CK,UAA3C,EAAuDC,EAAvD,CAAP;AACD;AACF,OAXD;;AAYAlC,MAAAA,OAAO,CAACS,KAAR,GAAgB,YAAW;AACzB,eAAOkB,gBAAgB,CAACS,OAAjB,CAAyBR,gBAAzB,CAAP;AACD,OAFD;;AAGA5B,MAAAA,OAAO,CAACW,IAAR,GAAe,YAAW;AACxB,eAAOgB,gBAAgB,CAACU,MAAjB,CAAwBT,gBAAxB,CAAP;AACD,OAFD;;AAGA5B,MAAAA,OAAO,CAACa,KAAR,GAAgB,UAASA,KAAT,EAAgB;AAC9B,eAAOc,gBAAgB,CAACW,OAAjB,CAAyBV,gBAAzB,EAA2Cf,KAA3C,CAAP;AACD,OAFD;;AAGA,aAAO,KAAKb,OAAL,CAAa6B,gBAAb,EAA+B7B,OAA/B,CAAP;AACD,KAjCD,MAiCO;AACL,aAAO,KAAKiB,eAAL,CAAqBsB,KAArB,CAA2BvC,OAA3B,EAAoCA,OAAO,CAACwB,MAAR,EAApC,CAAP;AACD;AACF;;AAEDgB,EAAAA,GAAG,CAACC,UAAD,EAAa;AACd,QAAI,EAAEA,UAAU,YAAY1D,iBAAxB,CAAJ,EAAgD;AAC9C,YAAM,IAAI2D,KAAJ,CAAW,eAAcD,UAAW,mDAApC,CAAN;AACD;;AACD,WAAO,KAAKpB,WAAL,CAAiBsB,IAAjB,CAAsBF,UAAtB,CAAP;AACD;;AA3EgD,CAA5C;AA+EA,IAAI1D,iBAAiB,GAAG,MAAMA,iBAAN,CAAwB;AACrDmB,EAAAA,KAAK,CAACF,OAAD,EAAUiC,UAAV,EAAsBC,EAAtB,EAA0BC,MAA1B,EAAkC;AACrC,WAAOnC,OAAO,CAACE,KAAR,CAAc+B,UAAd,EAA0BC,EAA1B,EAA8BC,MAA9B,CAAP;AACD;;AAED9B,EAAAA,OAAO,CAACL,OAAD,EAAUiC,UAAV,EAAsBC,EAAtB,EAA0BC,MAA1B,EAAkC;AACvC,WAAOnC,OAAO,CAACK,OAAR,CAAgB4B,UAAhB,EAA4BC,EAA5B,EAAgCC,MAAhC,CAAP;AACD;;AAED5B,EAAAA,OAAO,CAACP,OAAD,EAAUiC,UAAV,EAAsBC,EAAtB,EAA0B;AAC/B,WAAOlC,OAAO,CAACO,OAAR,CAAgB0B,UAAhB,EAA4BC,EAA5B,CAAP;AACD;;AAEDE,EAAAA,OAAO,CAACpC,OAAD,EAAU;AACf,WAAOA,OAAO,CAACS,KAAR,EAAP;AACD;;AAED4B,EAAAA,MAAM,CAACrC,OAAD,EAAU;AACd,WAAOA,OAAO,CAACW,IAAR,EAAP;AACD;;AAED2B,EAAAA,OAAO,CAACtC,OAAD,EAAUa,KAAV,EAAiB;AACtB,WAAOb,OAAO,CAACa,KAAR,CAAcA,KAAd,CAAP;AACD;;AAvBoD,CAAhD","sourcesContent":["var MiddlewarePublish, isInsideNoYieldsAllowed, savedYield,\n  hasProp = {}.hasOwnProperty;\n\nimport {\n  _\n} from 'meteor/underscore';\n\nimport Fiber from 'fibers';\n\nsavedYield = Fiber.yield;\n\n// When inside Meteor._noYieldsAllowed Fiber.yield is overridden with\n// a function which throws an exception, so is not savedYield anymore.\n// Afterwards Fiber.yield is restored back to savedYield.\nisInsideNoYieldsAllowed = function() {\n  return Fiber.yield !== savedYield;\n};\n\nMiddlewarePublish = class MiddlewarePublish {\n  constructor(publish1) {\n    var key, ref, value;\n    this.publish = publish1;\n    // We store those methods at construction time because\n    // we override them later on publish object.\n    this._publishAdded = this.publish.added.bind(this.publish);\n    this._publishChanged = this.publish.changed.bind(this.publish);\n    this._publishRemoved = this.publish.removed.bind(this.publish);\n    this._publishReady = this.publish.ready.bind(this.publish);\n    this._publishStop = this.publish.stop.bind(this.publish);\n    this._publishError = this.publish.error.bind(this.publish);\n    ref = this.publish;\n    for (key in ref) {\n      if (!hasProp.call(ref, key)) continue;\n      value = ref[key];\n      if (key !== 'added' && key !== 'changed' && key !== 'removed' && key !== 'ready' && key !== 'stop' && key !== 'error') {\n        this[key] = value;\n      }\n    }\n  }\n\n  added(...args) {\n    return this._publishAdded(...args);\n  }\n\n  changed(...args) {\n    return this._publishChanged(...args);\n  }\n\n  removed(...args) {\n    return this._publishRemoved(...args);\n  }\n\n  ready(...args) {\n    return this._publishReady(...args);\n  }\n\n  stop(...args) {\n    return this._publishStop(...args);\n  }\n\n  error(...args) {\n    return this._publishError(...args);\n  }\n\n};\n\nexport var PublishEndpoint = class PublishEndpoint {\n  constructor(options, publishFunction) {\n    var self;\n    this.options = options;\n    this.publishFunction = publishFunction;\n    // To pass null (autopublish) or string directly for name\n    if (this.options === null || _.isString(this.options)) {\n      this.options = {\n        name: this.options\n      };\n    }\n    this.middlewares = [];\n    self = this;\n    Meteor.publish(this.options.name, function(...args) {\n      var publish, state;\n      publish = this;\n      state = {};\n      publish.params = function() {\n        return args;\n      };\n      publish.set = function(key, value) {\n        return state[key] = value;\n      };\n      publish.get = function(key) {\n        return state[key];\n      };\n      return self.publish(self.middlewares, publish);\n    });\n  }\n\n  publish(middlewares, publish) {\n    var latestMiddleware, midlewarePublish, otherMiddlewares, publishRemoved;\n    if (middlewares.length) {\n      latestMiddleware = middlewares[middlewares.length - 1];\n      otherMiddlewares = middlewares.slice(0, middlewares.length - 1);\n      midlewarePublish = new MiddlewarePublish(publish);\n      publish.added = function(collection, id, fields) {\n        return latestMiddleware.added(midlewarePublish, collection, id, fields);\n      };\n      publish.changed = function(collection, id, fields) {\n        return latestMiddleware.changed(midlewarePublish, collection, id, fields);\n      };\n      publishRemoved = publish.removed;\n      publish.removed = function(collection, id) {\n        // When unsubscribing, Meteor removes all documents so this callback is called\n        // inside Meteor._noYieldsAllowed which means inside the callback no function\n        // which calls yield can be called. Because this is often not true, in that\n        // special case we are not going through middlewares but are directly calling\n        // original removed callback.\n        if (isInsideNoYieldsAllowed()) {\n          return publishRemoved.call(publish, collection, id);\n        } else {\n          return latestMiddleware.removed(midlewarePublish, collection, id);\n        }\n      };\n      publish.ready = function() {\n        return latestMiddleware.onReady(midlewarePublish);\n      };\n      publish.stop = function() {\n        return latestMiddleware.onStop(midlewarePublish);\n      };\n      publish.error = function(error) {\n        return latestMiddleware.onError(midlewarePublish, error);\n      };\n      return this.publish(otherMiddlewares, publish);\n    } else {\n      return this.publishFunction.apply(publish, publish.params());\n    }\n  }\n\n  use(middleware) {\n    if (!(middleware instanceof PublishMiddleware)) {\n      throw new Error(`Middleware '${middleware}' is not an instance of a PublishMiddleware class`);\n    }\n    return this.middlewares.push(middleware);\n  }\n\n};\n\nexport var PublishMiddleware = class PublishMiddleware {\n  added(publish, collection, id, fields) {\n    return publish.added(collection, id, fields);\n  }\n\n  changed(publish, collection, id, fields) {\n    return publish.changed(collection, id, fields);\n  }\n\n  removed(publish, collection, id) {\n    return publish.removed(collection, id);\n  }\n\n  onReady(publish) {\n    return publish.ready();\n  }\n\n  onStop(publish) {\n    return publish.stop();\n  }\n\n  onError(publish, error) {\n    return publish.error(error);\n  }\n\n};\n"]},"sourceType":"script","hash":"f78d8bc12d8988c2b1ad6d6db22c06f280f1dced"}
