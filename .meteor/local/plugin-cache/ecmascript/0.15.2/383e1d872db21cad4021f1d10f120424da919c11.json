{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"C:\\Users\\RUBEN\\Desktop\\meteor-vue\\packages\\socialize:base-model\\base-model.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"packages/socialize:base-model/base-model.js","filename":"C:\\Users\\RUBEN\\Desktop\\meteor-vue\\packages\\socialize:base-model\\base-model.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"C:\\Users\\RUBEN\\Desktop\\meteor-vue","root":"C:\\Users\\RUBEN\\Desktop\\meteor-vue","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.14.0","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"C:\\Users\\RUBEN\\Desktop\\meteor-vue\\packages\\socialize:base-model\\base-model.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/socialize:base-model/base-model.js"}},"code":"let SimpleSchema;\nmodule.link(\"simpl-schema\", {\n  default(v) {\n    SimpleSchema = v;\n  }\n\n}, 0);\nlet MessageBox;\nmodule.link(\"message-box\", {\n  default(v) {\n    MessageBox = v;\n  }\n\n}, 1);\nlet diff;\nmodule.link(\"mongodb-diff\", {\n  diff(v) {\n    diff = v;\n  }\n\n}, 2);\nmodule.exportDefault(Meteor => {\n  /* We check for server code here to deal with a buffer issue in meteor-message-box\n   * This shouldn't be a major issue as I doubt we will need to display this error\n   * on the client at this point. Should be fixed though.\n   * https://github.com/aldeed/meteor-message-box/issues/1\n  */\n  if (Meteor.isServer) {\n    MessageBox.defaults({\n      messages: {\n        en: {\n          Untrusted: 'Inserts/Updates from untrusted code not supported'\n        }\n      }\n    });\n  }\n\n  SimpleSchema.denyUntrusted = function denyUntrusted() {\n    if (this.isSet) {\n      const autoValue = this.definition.autoValue && this.definition.autoValue.call(this);\n      const {\n        defaultValue\n      } = this.definition;\n\n      if (this.value !== defaultValue && this.value !== autoValue && !this.isFromTrustedCode) {\n        return 'Untrusted';\n      }\n    }\n\n    return undefined;\n  };\n\n  function extend(receiver, provider) {\n    const rec = receiver;\n\n    for (const prop in provider) {\n      if (prop in provider) {\n        rec[prop] = provider[prop];\n      }\n    }\n  }\n\n  return class BaseModel {\n    constructor() {\n      let document = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      let preClean = arguments.length > 1 ? arguments[1] : undefined;\n      let doc = document;\n\n      if (preClean) {\n        doc = this._getSchema(doc).clean(doc);\n      }\n\n      extend(this, doc);\n\n      this.getDocument = function getDocument() {\n        return doc;\n      };\n    }\n\n    static createEmpty(_id) {\n      return new this({\n        _id\n      });\n    }\n\n    static methods(methodMap) {\n      const self = this;\n\n      if ((typeof methodMap === 'function' || typeof methodMap === 'object') && !!methodMap) {\n        const keys = Object.keys(methodMap);\n\n        for (let i = 0, {\n          length\n        } = keys; i < length; i++) {\n          const method = methodMap[keys[i]];\n\n          if (typeof method === 'function') {\n            if (!self.prototype[keys[i]]) {\n              self.prototype[keys[i]] = method;\n            } else {\n              throw new Meteor.Error('existent-method', \"The method \".concat(keys[i], \" already exists.\"));\n            }\n          }\n        }\n      }\n    }\n\n    static updateTransformFunction() {\n      this.prototype.getCollection()._transform = document => new this(document);\n    }\n\n    static attachCollection(collection) {\n      let transform = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n\n      this.prototype.getCollection = function getCollection() {\n        return collection;\n      };\n\n      if (transform) {\n        this.updateTransformFunction();\n      }\n    }\n\n    static attachSchema(schemaInstance) {\n      const collection = this.prototype.getCollection();\n\n      if (collection) {\n        collection.attachSchema(schemaInstance);\n      } else {\n        throw new Meteor.Error(\"Can't append schema to non existent collection. Please attach a collection to your model using `ModelName.attachCollection`\");\n      }\n    }\n\n    static appendSchema(schemaObject) {\n      this.attachSchema(new SimpleSchema(schemaObject));\n    }\n\n    _getSchema() {\n      const schema = this.getCollection().simpleSchema(...arguments);\n\n      if (schema) {\n        return schema;\n      }\n\n      throw new Meteor.Error('noSchema', \"You don't have a schema defined for \".concat(this.getCollectionName()));\n    }\n\n    getCollection() {\n      // We just throw here. This method is reassigned in attachCollection method when collection is attached.\n      if (this) throw new Meteor.Error('noCollection', 'You must use ClassName.attachCollection to attach a collection to your model.');\n    }\n\n    getCollectionName() {\n      return this.getCollection()._name;\n    } // get all values from the model that do not have a denyUpdate or denyUntrusted in their schema\n\n\n    getUpdatableFields() {\n      const schemas = Meteor._get(this.getCollection(), '_c2', '_simpleSchemas');\n\n      const fields = {\n        _id: this._id\n      };\n\n      for (const key of Object.keys(this)) {\n        schemas.forEach(_ref => {\n          let {\n            schema\n          } = _ref;\n\n          if (schema[key] && !(schema[key].custom && schema[key].custom === SimpleSchema.denyUntrusted) && !schema[key].denyUpdate) {\n            fields[key] = this[key];\n          }\n        });\n      }\n\n      return fields;\n    }\n\n    checkOwnership() {\n      return this.userId === Meteor.userId();\n    }\n\n    save(callback) {\n      let obj = Object.keys(this).reduce((accumulator, key) => {\n        if (key !== 'getDocument') accumulator[key] = this[key]; // eslint-disable-line no-param-reassign\n\n        return accumulator;\n      }, {});\n\n      if (this._id) {\n        const updateDiff = diff(this.getDocument(), obj);\n\n        if (updateDiff && Object.keys(updateDiff).length !== 0) {\n          this.update(updateDiff, callback);\n        } else {\n          callback && callback(null);\n        }\n      } else {\n        const schema = this._getSchema(obj);\n\n        if (Meteor.isClient && schema) {\n          obj = schema.clean(obj, {\n            extendAutoValueContext: {\n              isInsert: true,\n              userId: Meteor.userId()\n            }\n          });\n        }\n\n        this._id = this.getCollection().insert(obj, callback);\n      }\n\n      return this;\n    }\n\n    update(modifier, callback) {\n      if (this._id) {\n        this.getCollection().update(this._id, modifier, callback);\n      }\n    }\n\n    remove(callback) {\n      if (this._id) {\n        this.getCollection().remove({\n          _id: this._id\n        }, callback);\n      }\n    }\n\n  };\n});","map":{"version":3,"sources":["packages/socialize:base-model/base-model.js"],"names":["SimpleSchema","module","link","default","v","MessageBox","diff","exportDefault","Meteor","isServer","defaults","messages","en","Untrusted","denyUntrusted","isSet","autoValue","definition","call","defaultValue","value","isFromTrustedCode","undefined","extend","receiver","provider","rec","prop","BaseModel","constructor","document","preClean","doc","_getSchema","clean","getDocument","createEmpty","_id","methods","methodMap","self","keys","Object","i","length","method","prototype","Error","updateTransformFunction","getCollection","_transform","attachCollection","collection","transform","attachSchema","schemaInstance","appendSchema","schemaObject","schema","simpleSchema","getCollectionName","_name","getUpdatableFields","schemas","_get","fields","key","forEach","custom","denyUpdate","checkOwnership","userId","save","callback","obj","reduce","accumulator","updateDiff","update","isClient","extendAutoValueContext","isInsert","insert","modifier","remove"],"mappings":"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","sourcesContent":["/* eslint-disable import/no-unresolved */\nimport SimpleSchema from 'simpl-schema';\nimport MessageBox from 'message-box';\nimport { diff } from 'mongodb-diff';\n/* eslint-enable import/no-unresolved */\n\nexport default (Meteor) => {\n    /* We check for server code here to deal with a buffer issue in meteor-message-box\n     * This shouldn't be a major issue as I doubt we will need to display this error\n     * on the client at this point. Should be fixed though.\n     * https://github.com/aldeed/meteor-message-box/issues/1\n    */\n    if (Meteor.isServer) {\n        MessageBox.defaults({\n            messages: {\n                en: {\n                    Untrusted: 'Inserts/Updates from untrusted code not supported',\n                },\n            },\n        });\n    }\n\n    SimpleSchema.denyUntrusted = function denyUntrusted() {\n        if (this.isSet) {\n            const autoValue = this.definition.autoValue && this.definition.autoValue.call(this);\n            const { defaultValue } = this.definition;\n\n            if (this.value !== defaultValue && this.value !== autoValue && !this.isFromTrustedCode) {\n                return 'Untrusted';\n            }\n        }\n        return undefined;\n    };\n\n    function extend(receiver, provider) {\n        const rec = receiver;\n        for (const prop in provider) {\n            if (prop in provider) {\n                rec[prop] = provider[prop];\n            }\n        }\n    }\n\n    return class BaseModel {\n        constructor(document = {}, preClean) {\n            let doc = document;\n            if (preClean) {\n                doc = this._getSchema(doc).clean(doc);\n            }\n            extend(this, doc);\n            this.getDocument = function getDocument() {\n                return doc;\n            };\n        }\n\n        static createEmpty(_id) {\n            return new this({ _id });\n        }\n\n        static methods(methodMap) {\n            const self = this;\n            if ((typeof methodMap === 'function' || typeof methodMap === 'object') && !!methodMap) {\n                const keys = Object.keys(methodMap);\n                for (let i = 0, { length } = keys; i < length; i++) {\n                    const method = methodMap[keys[i]];\n\n                    if (typeof method === 'function') {\n                        if (!self.prototype[keys[i]]) {\n                            self.prototype[keys[i]] = method;\n                        } else {\n                            throw new Meteor.Error('existent-method', `The method ${keys[i]} already exists.`);\n                        }\n                    }\n                }\n            }\n        }\n\n        static updateTransformFunction() {\n            this.prototype.getCollection()._transform = document => new this(document);\n        }\n\n        static attachCollection(collection, transform = true) {\n            this.prototype.getCollection = function getCollection() {\n                return collection;\n            };\n\n            if (transform) {\n                this.updateTransformFunction();\n            }\n        }\n\n        static attachSchema(schemaInstance) {\n            const collection = this.prototype.getCollection();\n\n            if (collection) {\n                collection.attachSchema(schemaInstance);\n            } else {\n                throw new Meteor.Error(\"Can't append schema to non existent collection. Please attach a collection to your model using `ModelName.attachCollection`\");\n            }\n        }\n\n        static appendSchema(schemaObject) {\n            this.attachSchema(new SimpleSchema(schemaObject));\n        }\n\n        _getSchema(...args) {\n            const schema = this.getCollection().simpleSchema(...args);\n            if (schema) {\n                return schema;\n            }\n            throw new Meteor.Error('noSchema', `You don't have a schema defined for ${this.getCollectionName()}`);\n        }\n\n        getCollection() {\n            // We just throw here. This method is reassigned in attachCollection method when collection is attached.\n            if (this) throw new Meteor.Error('noCollection', 'You must use ClassName.attachCollection to attach a collection to your model.');\n        }\n\n        getCollectionName() {\n            return this.getCollection()._name;\n        }\n\n        // get all values from the model that do not have a denyUpdate or denyUntrusted in their schema\n        getUpdatableFields() {\n            const schemas = Meteor._get(this.getCollection(), '_c2', '_simpleSchemas');\n            const fields = { _id: this._id };\n\n            for (const key of Object.keys(this)) {\n                schemas.forEach(({ schema }) => {\n                    if (schema[key] && !(schema[key].custom && schema[key].custom === SimpleSchema.denyUntrusted) && !schema[key].denyUpdate) {\n                        fields[key] = this[key];\n                    }\n                });\n            }\n\n            return fields;\n        }\n\n        checkOwnership() {\n            return this.userId === Meteor.userId();\n        }\n\n        save(callback) {\n            let obj = Object.keys(this).reduce(\n                (accumulator, key) => {\n                    if (key !== 'getDocument') accumulator[key] = this[key]; // eslint-disable-line no-param-reassign\n                    return accumulator;\n                }, {},\n            );\n\n            if (this._id) {\n                const updateDiff = diff(this.getDocument(), obj);\n                if (updateDiff && Object.keys(updateDiff).length !== 0) {\n                    this.update(updateDiff, callback);\n                } else {\n                    callback && callback(null);\n                }\n            } else {\n                const schema = this._getSchema(obj);\n                if (Meteor.isClient && schema) {\n                    obj = schema.clean(obj, {\n                        extendAutoValueContext: {\n                            isInsert: true,\n                            userId: Meteor.userId(),\n                        },\n                    });\n                }\n                this._id = this.getCollection().insert(obj, callback);\n            }\n\n            return this;\n        }\n\n        update(modifier, callback) {\n            if (this._id) {\n                this.getCollection().update(this._id, modifier, callback);\n            }\n        }\n\n        remove(callback) {\n            if (this._id) {\n                this.getCollection().remove({ _id: this._id }, callback);\n            }\n        }\n    };\n};\n"]},"sourceType":"module","hash":"383e1d872db21cad4021f1d10f120424da919c11"}
