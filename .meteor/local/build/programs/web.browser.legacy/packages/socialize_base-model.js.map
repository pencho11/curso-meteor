{"version":3,"sources":["meteor://ðŸ’»app/packages/socialize:base-model/entry-meteor.js","meteor://ðŸ’»app/packages/socialize:base-model/base-model.js"],"names":["module","export","BaseModel","Meteor","link","v","construct","_typeof","default","SimpleSchema","MessageBox","diff","exportDefault","isServer","defaults","messages","en","Untrusted","denyUntrusted","isSet","autoValue","definition","call","defaultValue","value","isFromTrustedCode","undefined","extend","receiver","provider","rec","prop","document","preClean","doc","_getSchema","clean","getDocument","createEmpty","_id","methods","methodMap","self","keys","Object","i","length","method","prototype","Error","updateTransformFunction","getCollection","_transform","attachCollection","collection","transform","attachSchema","schemaInstance","appendSchema","schemaObject","schema","simpleSchema","getCollectionName","_name","getUpdatableFields","schemas","_get","fields","key","forEach","custom","denyUpdate","checkOwnership","userId","save","callback","obj","reduce","accumulator","updateDiff","update","isClient","extendAutoValueContext","isInsert","insert","modifier","remove"],"mappings":"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","file":"/packages/socialize_base-model.js","sourcesContent":["/* eslint-disable import/no-unresolved */\nimport { Meteor } from 'meteor/meteor';\nimport construct from './base-model';\n/* eslint-enable import/no-unresolved */\n\nconst BaseModel = construct(Meteor);\n\nexport { BaseModel };\n","/* eslint-disable import/no-unresolved */\nimport SimpleSchema from 'simpl-schema';\nimport MessageBox from 'message-box';\nimport { diff } from 'mongodb-diff';\n/* eslint-enable import/no-unresolved */\n\nexport default (Meteor) => {\n    /* We check for server code here to deal with a buffer issue in meteor-message-box\n     * This shouldn't be a major issue as I doubt we will need to display this error\n     * on the client at this point. Should be fixed though.\n     * https://github.com/aldeed/meteor-message-box/issues/1\n    */\n    if (Meteor.isServer) {\n        MessageBox.defaults({\n            messages: {\n                en: {\n                    Untrusted: 'Inserts/Updates from untrusted code not supported',\n                },\n            },\n        });\n    }\n\n    SimpleSchema.denyUntrusted = function denyUntrusted() {\n        if (this.isSet) {\n            const autoValue = this.definition.autoValue && this.definition.autoValue.call(this);\n            const { defaultValue } = this.definition;\n\n            if (this.value !== defaultValue && this.value !== autoValue && !this.isFromTrustedCode) {\n                return 'Untrusted';\n            }\n        }\n        return undefined;\n    };\n\n    function extend(receiver, provider) {\n        const rec = receiver;\n        for (const prop in provider) {\n            if (prop in provider) {\n                rec[prop] = provider[prop];\n            }\n        }\n    }\n\n    return class BaseModel {\n        constructor(document = {}, preClean) {\n            let doc = document;\n            if (preClean) {\n                doc = this._getSchema(doc).clean(doc);\n            }\n            extend(this, doc);\n            this.getDocument = function getDocument() {\n                return doc;\n            };\n        }\n\n        static createEmpty(_id) {\n            return new this({ _id });\n        }\n\n        static methods(methodMap) {\n            const self = this;\n            if ((typeof methodMap === 'function' || typeof methodMap === 'object') && !!methodMap) {\n                const keys = Object.keys(methodMap);\n                for (let i = 0, { length } = keys; i < length; i++) {\n                    const method = methodMap[keys[i]];\n\n                    if (typeof method === 'function') {\n                        if (!self.prototype[keys[i]]) {\n                            self.prototype[keys[i]] = method;\n                        } else {\n                            throw new Meteor.Error('existent-method', `The method ${keys[i]} already exists.`);\n                        }\n                    }\n                }\n            }\n        }\n\n        static updateTransformFunction() {\n            this.prototype.getCollection()._transform = document => new this(document);\n        }\n\n        static attachCollection(collection, transform = true) {\n            this.prototype.getCollection = function getCollection() {\n                return collection;\n            };\n\n            if (transform) {\n                this.updateTransformFunction();\n            }\n        }\n\n        static attachSchema(schemaInstance) {\n            const collection = this.prototype.getCollection();\n\n            if (collection) {\n                collection.attachSchema(schemaInstance);\n            } else {\n                throw new Meteor.Error(\"Can't append schema to non existent collection. Please attach a collection to your model using `ModelName.attachCollection`\");\n            }\n        }\n\n        static appendSchema(schemaObject) {\n            this.attachSchema(new SimpleSchema(schemaObject));\n        }\n\n        _getSchema(...args) {\n            const schema = this.getCollection().simpleSchema(...args);\n            if (schema) {\n                return schema;\n            }\n            throw new Meteor.Error('noSchema', `You don't have a schema defined for ${this.getCollectionName()}`);\n        }\n\n        getCollection() {\n            // We just throw here. This method is reassigned in attachCollection method when collection is attached.\n            if (this) throw new Meteor.Error('noCollection', 'You must use ClassName.attachCollection to attach a collection to your model.');\n        }\n\n        getCollectionName() {\n            return this.getCollection()._name;\n        }\n\n        // get all values from the model that do not have a denyUpdate or denyUntrusted in their schema\n        getUpdatableFields() {\n            const schemas = Meteor._get(this.getCollection(), '_c2', '_simpleSchemas');\n            const fields = { _id: this._id };\n\n            for (const key of Object.keys(this)) {\n                schemas.forEach(({ schema }) => {\n                    if (schema[key] && !(schema[key].custom && schema[key].custom === SimpleSchema.denyUntrusted) && !schema[key].denyUpdate) {\n                        fields[key] = this[key];\n                    }\n                });\n            }\n\n            return fields;\n        }\n\n        checkOwnership() {\n            return this.userId === Meteor.userId();\n        }\n\n        save(callback) {\n            let obj = Object.keys(this).reduce(\n                (accumulator, key) => {\n                    if (key !== 'getDocument') accumulator[key] = this[key]; // eslint-disable-line no-param-reassign\n                    return accumulator;\n                }, {},\n            );\n\n            if (this._id) {\n                const updateDiff = diff(this.getDocument(), obj);\n                if (updateDiff && Object.keys(updateDiff).length !== 0) {\n                    this.update(updateDiff, callback);\n                } else {\n                    callback && callback(null);\n                }\n            } else {\n                const schema = this._getSchema(obj);\n                if (Meteor.isClient && schema) {\n                    obj = schema.clean(obj, {\n                        extendAutoValueContext: {\n                            isInsert: true,\n                            userId: Meteor.userId(),\n                        },\n                    });\n                }\n                this._id = this.getCollection().insert(obj, callback);\n            }\n\n            return this;\n        }\n\n        update(modifier, callback) {\n            if (this._id) {\n                this.getCollection().update(this._id, modifier, callback);\n            }\n        }\n\n        remove(callback) {\n            if (this._id) {\n                this.getCollection().remove({ _id: this._id }, callback);\n            }\n        }\n    };\n};\n"]}