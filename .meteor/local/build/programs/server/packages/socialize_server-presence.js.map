{"version":3,"sources":["meteor://ðŸ’»app/packages/socialize:server-presence/server-presence.js"],"names":["module","export","ServerPresence","Meteor","link","v","Mongo","Servers","Collection","_ensureIndex","lastPing","expireAfterSeconds","createdAt","serverId","isWatcher","observeHandle","exitGracefully","exitFunctions","insert","date","Date","runCleanupFunctions","removedServerId","forEach","exitFunc","setAsWatcher","update","_id","$set","watcher","updateWatcher","server","findOne","sort","observe","find","removed","document","_debug","process","kill","pid","graceful","checkForWatcher","current","start","setInterval","serverTick","exit","stop","bindEnvironment","boundEnvironment","onCleanup","cleanupFunction","push","Error","startup","sig","once"],"mappings":"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","file":"/packages/socialize_server-presence.js","sourcesContent":["/* eslint-disable import/no-unresolved */\nimport { Meteor } from 'meteor/meteor';\nimport { Mongo } from 'meteor/mongo';\n/* eslint-enable import/no-unresolved */\n\nconst Servers = new Mongo.Collection('presence:servers');\n\nServers._ensureIndex({ lastPing: 1 }, { expireAfterSeconds: 10 });\nServers._ensureIndex({ createdAt: -1 });\n\nlet serverId = null;\nlet isWatcher = false;\nlet observeHandle = null;\nlet exitGracefully = true;\n\nconst exitFunctions = [];\n\n/* eslint-disable import/prefer-default-export */\nexport const ServerPresence = {};\n\nconst insert = () => {\n    const date = new Date();\n    serverId = Servers.insert({ lastPing: date, createdAt: date });\n};\n\nconst runCleanupFunctions = (removedServerId) => {\n    exitFunctions.forEach((exitFunc) => {\n        exitFunc(removedServerId);\n    });\n};\n\nconst setAsWatcher = () => {\n    isWatcher = true;\n    Servers.update({ _id: serverId }, { $set: { watcher: true } });\n};\n\nconst updateWatcher = () => {\n    const server = Servers.findOne({}, { sort: { createdAt: -1 } });\n    if (server._id === serverId) {\n        setAsWatcher();\n    }\n};\n\nconst observe = () => {\n    observeHandle = Servers.find().observe({\n        removed(document) {\n            if (document._id === serverId) {\n                if (!isWatcher) {\n                    Meteor._debug('Server Presence Timeout', 'The server-presence package has detected inconsistent presence state. To avoid inconsistent database state your application is exiting.');\n                    exitGracefully = false;\n                    process.kill(process.pid, 'SIGHUP');\n                } else {\n                    insert();\n                }\n            } else if (isWatcher) {\n                if (!document.graceful) {\n                    runCleanupFunctions(document._id);\n                }\n            } else if (document.watcher) {\n                if (!document.graceful) {\n                    runCleanupFunctions(document._id);\n                }\n                updateWatcher();\n            }\n        },\n    });\n};\n\nconst checkForWatcher = () => {\n    const current = Servers.findOne({ watcher: true });\n    if (current) {\n        return true;\n    }\n    setAsWatcher();\n    return false;\n};\n\nconst start = () => {\n    observe();\n\n    Meteor.setInterval(function serverTick() {\n        Servers.update(serverId, { $set: { lastPing: new Date() } });\n        return true;\n    }, 5000);\n\n    insert();\n\n    // if there isn't any other instance watching and doing cleanup\n    // then we need to do a full cleanup since this is likely the only instance\n    if (!checkForWatcher()) {\n        runCleanupFunctions();\n    }\n};\n\nconst exit = () => {\n    // Call all of our externally supplied exit functions\n    runCleanupFunctions(serverId);\n};\n\n/*\n*  We have to bind the meteor environment here since process event callbacks\n*  run outside fibers\n*/\nconst stop = Meteor.bindEnvironment(function boundEnvironment() {\n    if (exitGracefully) {\n        Servers.update({ _id: serverId }, { $set: { graceful: true } });\n        observeHandle.stop();\n        exit();\n    }\n});\n\n\nServerPresence.onCleanup = (cleanupFunction) => {\n    if (typeof cleanupFunction === 'function') {\n        exitFunctions.push(cleanupFunction);\n    } else {\n        throw new Meteor.Error('Not A Function', 'ServerPresence.onCleanup requires function as parameter');\n    }\n};\n\nServerPresence.serverId = () => serverId;\n\nMeteor.startup(() => {\n    start();\n});\n\n/*\n*  Here we are catching signals due to the fact that node (Maybe it's a Meteor issue?) doesn't\n*  seem to run the exit callbacks except for SIGHUP. Being that SIGTERM is the standard POSIX\n*  signal sent when a system shuts down, it doesn't make much sense to only run out cleanup on\n*  HUP signals.\n*/\n\n['SIGINT', 'SIGHUP', 'SIGTERM'].forEach((sig) => {\n  process.once(sig, () => {\n    stop();\n    process.kill(process.pid, sig);\n  });\n});\n"]}