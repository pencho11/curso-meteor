{"version":3,"sources":["meteor://ðŸ’»app/packages/blaze-hot/hot.js","meteor://ðŸ’»app/packages/blaze-hot/update-templates.js"],"names":["importedTemplating","currentModule","id","SourceModule","Symbol","oldRegisterHelper","Template","func","oldOnCreated","cb","oldOnRendered","oldOnDestroyed","oldHelpers","dict","oldEvents","result","usedModule","Blaze","i","array","item","cleanArray","template","Object","key","module","patchTemplate","before","previousModule","after","shouldAccept","templateName","Templates","usedByModule","cleanTemplate","helper","UpdateAll","renderedTemplates","overrideTemplateContentBlock","overrideTemplateElseBlock","oldConstructView","view","index","updateRootViews","timeout","lastUpdateFailed","modifiedTemplates","templateViewPrefix","clearTimeout","setTimeout","viewName","console","views","Package","parent","parentElement","next","nextComment","document","newView","member"],"mappings":"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","file":"/packages/blaze-hot.js","sourcesContent":["import { Blaze } from 'meteor/blaze';\nimport { Template as Templates} from 'meteor/templating-runtime';\nimport { UpdateAll } from './update-templates.js';\n\nlet importedTemplating = new WeakMap();\nlet currentModule = {id: null};\nconst SourceModule = Symbol();\n\nfunction patchTemplate(Template) {\n  const oldRegisterHelper = Template.registerHelper;\n  Template.registerHelper = function (name, func) {\n    func[SourceModule] = currentModule.id;\n    oldRegisterHelper(name, func);\n  }\n\n  const oldOnCreated = Template.prototype.onCreated;\n  Template.prototype.onCreated = function (cb) {\n    if (cb) {\n      cb[SourceModule] = currentModule.id;\n    }\n\n    return oldOnCreated.call(this, cb);\n  }\n\n  const oldOnRendered = Template.prototype.onRendered;\n  Template.prototype.onRendered = function (cb) {\n    if (cb) {\n      cb[SourceModule] = currentModule.id;\n    }\n\n    return oldOnRendered.call(this, cb);\n  }\n\n  const oldOnDestroyed = Template.prototype.onDestroyed;\n  Template.prototype.onDestroyed = function (cb) {\n    if (cb) {\n      cb[SourceModule] = currentModule.id;\n    }\n\n    return oldOnDestroyed.call(this, cb);\n  }\n\n  const oldHelpers = Template.prototype.helpers;\n  Template.prototype.helpers = function (dict) {\n    if (typeof dict === 'object') {\n      for (var k in dict) {\n        if (dict[k]) {\n          dict[k][SourceModule] = currentModule.id;\n        }\n      }\n    }\n\n    return oldHelpers.call(this, dict);\n  }\n\n  const oldEvents = Template.prototype.events;\n  Template.prototype.events = function (eventMap) {\n    const result = oldEvents.call(this, eventMap);\n    this.__eventMaps[this.__eventMaps.length - 1][SourceModule] = currentModule.id;\n    return result;\n  }\n}\n\nfunction cleanTemplate(template, moduleId) {\n  let usedModule = false\n  if (!template || !Blaze.isTemplate(template)) {\n    return usedModule;\n  }\n\n  function cleanArray(array) {\n    for (let i = array.length - 1; i >= 0; i--) {\n      let item = array[i];\n      if (item && item[SourceModule] === moduleId) {\n        usedModule = true\n        array.splice(i, 1);\n      }\n    }\n  }\n\n  cleanArray(template._callbacks.created);\n  cleanArray(template._callbacks.rendered);\n  cleanArray(template._callbacks.destroyed);\n  cleanArray(template.__eventMaps);\n\n  Object.keys(template.__helpers).forEach(key => {\n    if (template.__helpers[key] && template.__helpers[key][SourceModule] === moduleId) {\n      usedModule = true\n      delete template.__helpers[key];\n    }\n  });\n\n  return usedModule\n}\n\nfunction shouldAccept(module) {\n  if (!importedTemplating.get(module)) {\n    return false;\n  }\n  if (!module.exports) {\n    return true;\n  }\n\n  return Object.keys(module.exports).filter(key => key !== '__esModule').length === 0;\n}\n\nif (module.hot) {\n  patchTemplate(Blaze.Template);\n  module.hot.onRequire({\n    before(module) {\n      if (module.id === '/node_modules/meteor/blaze.js' || module.id === '/node_modules/meteor/templating.js') {\n        importedTemplating.set(currentModule, true);\n      }\n\n      let previousModule = currentModule;\n      currentModule = module;\n      return previousModule;\n    },\n    after(module, previousModule) {\n      if (shouldAccept(module)) {\n        module.hot.accept();\n        module.hot.dispose(() => {\n          Object.keys(Templates).forEach(templateName => {\n            let template = Templates[templateName]\n            let usedByModule = cleanTemplate(template, module.id);\n            if (usedByModule) {\n              Template._applyHmrChanges(templateName);\n            }\n          });\n\n          Object.values(Blaze._globalHelpers).forEach(helper => {\n            if (helper && helper[SourceModule] === module.id) {\n              Template._applyHmrChanges(UpdateAll);\n            }\n          });\n        });\n      }\n      currentModule = previousModule\n    }\n  });\n}\n","export const UpdateAll = Symbol('update all templates')\n\nlet renderedTemplates = {};\nlet overrideTemplateContentBlock = null;\nlet overrideTemplateElseBlock = null;\n\nconst oldConstructView = Template.prototype.constructView;\n\nTemplate.prototype.constructView = function () {\n  let view = oldConstructView.apply(this, arguments);\n  let templateName = this.viewName;\n\n  view.onViewCreated(function () {\n    renderedTemplates[templateName] = renderedTemplates[templateName] || [];\n    renderedTemplates[templateName].push(view);\n  });\n\n  view.onViewDestroyed(function () {\n    const index = renderedTemplates[templateName].indexOf(view);\n    if (index > -1) {\n      renderedTemplates[templateName].splice(index, 1);\n    }\n  });\n\n  if (overrideTemplateContentBlock) {\n    view.templateContentBlock = overrideTemplateContentBlock;\n    overrideTemplateContentBlock = null;\n  }\n\n  if (overrideTemplateElseBlock) {\n    view.templateElseBlock = overrideTemplateElseBlock;\n    overrideTemplateElseBlock = null;\n  }\n\n  return view;\n}\n\nlet updateRootViews = Template._applyHmrChanges;\n\nlet timeout = null;\nlet lastUpdateFailed = false;\nlet modifiedTemplates = new Set();\nlet templateViewPrefix = 'Template.';\n\n// Overrides the default _applyHmrChanges with one that updates the specific\n// views for modified templates instead of updating everything.\nTemplate._applyHmrChanges = function (templateName = UpdateAll) {\n  if (templateName === UpdateAll || lastUpdateFailed) {\n    lastUpdateFailed = false;\n    clearTimeout(timeout);\n    updateRootViews();\n    return;\n  } else {\n    modifiedTemplates.add(templateName);\n  }\n\n  if (timeout) {\n    return;\n  }\n\n  timeout = setTimeout(() => {\n    for (var i = 0; i < Template.__pendingReplacement.length; i++) {\n      delete Template[Template.__pendingReplacement[i]]\n    }\n\n    Template.__pendingReplacement = [];\n\n    timeout = null;\n    modifiedTemplates.forEach(templateName => {\n      modifiedTemplates.delete(templateName);\n      let viewName = templateName;\n\n      if (!(viewName in renderedTemplates)) {\n        viewName = templateViewPrefix + viewName;\n      } else {\n        console.error('[Blaze HMR] Error: view name does not start with Template');\n        return;\n      }\n\n      if (!(viewName in renderedTemplates)) {\n        return;\n      }\n\n      let views = renderedTemplates[viewName];\n      renderedTemplates[viewName] = [];\n      while (views.length > 0) {\n        let view = views.pop();\n\n        // find first parent template that isn't a content block\n        while (!view.template || view.templateContentBlock || view.templateElseBlock) {\n          if (!view.parentView) {\n            console.log('[Blaze HMR] Unable to update template', viewName);\n            return;\n          }\n\n          view = view.parentView;\n        }\n\n        if (!view.isRendered) {\n          continue;\n        }\n\n        // TODO: this can be removed if we don't update a view, and then update\n        // one of its children (we only need to update the parent).\n        Package.tracker.Tracker.flush();\n\n        let parent = view.parentView;\n        let parentElement = view._domrange.parentElement;\n        let next = view._domrange.lastNode().nextSibling;\n        let nextComment = null;\n\n        if (!next) {\n          // percolate:momentum requires a next node to show the new nodes\n          next = nextComment = document.createComment('Blaze HMR Placeholder');\n          parentElement.insertBefore(nextComment, null);\n        }\n\n        if (!parent) {\n          // TODO: we only need to update a single root view\n          return updateRootViews();\n        }\n\n        if (view.templateContentBlock) {\n          overrideTemplateContentBlock = view.templateContentBlock;\n        }\n        if (view.templateElseBlock) {\n          overrideTemplateElseBlock = view.templateElseBlock;\n        }\n\n        // Since there is a parent range, Blaze will not automatically\n        // detach the dom range.\n        view._domrange.detach();\n        view._domrange.destroy();\n        let newView;\n\n        try {\n          newView = Blaze.render(\n            Template[view.template.viewName.slice('Template.'.length)],\n            parentElement,\n            next,\n            parent\n          );\n        } catch (error) {\n          console.log('[Blaze HMR] Error re-rending template:');\n          console.error(error);\n          lastUpdateFailed = true;\n        }\n\n        let index = parent._domrange.members.findIndex(member => {\n          return member && member.view === view;\n        });\n        if (newView) {\n          parent._domrange.members.splice(index, 1, newView._domrange);\n        } else {\n          parent._domrange.members.splice(index, 1);\n        }\n\n        if (nextComment) {\n          parentElement.removeChild(nextComment);\n        }\n      }\n    });\n  });\n}\n"]}